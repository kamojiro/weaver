# Weaver v2 å­¦ç¿’è¨˜éŒ² - 2026-01-07

## ğŸ“… ä»Šæ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³

**é–‹å§‹æ—¥æ™‚:** 2026-01-07
**ãƒ•ã‚§ãƒ¼ã‚º:** Week 1 - éª¨æ ¼ã¨ Typed APIï¼ˆæ­£ã—ã•ã®åœŸå°ï¼‰
**ã‚¿ã‚¹ã‚¯:** PR-3: Typed Task APIï¼ˆå®Œæˆï¼‰

---

## ğŸ¯ ä»Šæ—¥ã®ç›®æ¨™

- [x] å‰å›ï¼ˆ2026-01-06ï¼‰ã®ç¶šãã‹ã‚‰é–‹å§‹
- [x] registry.rs - TypedRegistry ã®å®Ÿè£…å®Œäº†
- [x] codec.rs - PayloadCodec ã®å®Ÿè£…å®Œäº†
- [x] handler.rs - ãƒ†ã‚¹ãƒˆã®è¿½åŠ 
- [x] typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“ã®ãƒ†ã‚¹ãƒˆæˆåŠŸ
- [x] PR-3: Typed Task APIï¼ˆå®Œäº†ï¼‰

---

## ğŸ“ å®Ÿè£…ãƒ¡ãƒ¢

### é–‹å§‹æ™‚åˆ»
2026-01-07 ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹

### å‰å›ã‹ã‚‰ã®ç¶™ç¶š

å‰å›ï¼ˆ2026-01-06ï¼‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ä»¥ä¸‹ã¾ã§å®Œäº†ï¼š
- task.rs - Task trait ã¨ TestTask/AnotherTestTask
- handler.rs - Handler<T>, DynHandler, TypedHandler
- errors.rs - WeaverError ã®ç°¡æ˜“å®Ÿè£…

ä»Šæ—¥ã¯æ®‹ã‚Šã®å®Ÿè£…ã‚’å®Œäº†ã•ã›ã¾ã™ã€‚

### å®Ÿè£…ã®æµã‚Œ

#### 1. registry.rs ã®å®Ÿè£…
- **å®Ÿè£…å†…å®¹:**
  - TypedRegistry struct ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ï¼ˆHashMap<String, Arc<dyn DynHandler>>ï¼‰
  - RegistryError enum ã®å®šç¾©ï¼ˆAlreadyRegisteredï¼‰
  - new(), register<T, H>(), get(), registered_types() ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
  - ãƒ†ã‚¹ãƒˆ 4 å€‹ã®è¿½åŠ 

- **å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ:**
  - Arc ã®ä½¿ç”¨ç†ç”±: get() ã§è¿”ã™éš›ã«å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹ã ã‘ï¼ˆè»½é‡ï¼‰
  - äºŒé‡ç™»éŒ²ãƒã‚§ãƒƒã‚¯: æ„å›³ã—ãªã„ Handler ã®ç½®ãæ›ãˆã‚’é˜²ã
  - TypedHandler::new() ã§ Handler<T> â†’ DynHandler ã¸ã®å¤‰æ›
  - HashMap ã®ã‚­ãƒ¼ã¯ Stringï¼ˆæ‰€æœ‰å‹ï¼‰ãŒå¿…è¦

- **ãƒ†ã‚¹ãƒˆçµæœ:**
  ```
  test typed::registry::tests::test_register_and_get ... ok
  test typed::registry::tests::test_double_registration ... ok
  test typed::registry::tests::test_registered_types ... ok
  test typed::registry::tests::test_different_task_types ... ok
  ```

#### 2. handler.rs ã®ä¿®æ­£
- **å®Ÿè£…å†…å®¹:**
  - AnotherTestTaskHandler ã®è¿½åŠ 
  - import ã®æ•´ç†ï¼ˆuse super::task::{Task, TestTask, AnotherTestTask}ï¼‰
  - ãƒ†ã‚¹ãƒˆ 1 å€‹ã®è¿½åŠ ï¼ˆtest_typed_handlerï¼‰

- **å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ:**
  - #[tokio::test] ã‚’ä½¿ã£ãŸ async ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹
  - TypedHandler ã®å‹•ä½œç¢ºèªï¼ˆdeserialize â†’ handleï¼‰

#### 3. codec.rs ã®å®Ÿè£…
- **å®Ÿè£…å†…å®¹:**
  - CodecError enum ã®å®šç¾©ï¼ˆSerializeFailed, DeserializeFailedï¼‰
  - encode<T: Task>() ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
  - decode<T: Task>() ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
  - ãƒ†ã‚¹ãƒˆ 2 å€‹ã®è¿½åŠ 

- **å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ:**
  - serde_json::to_value() ã¨ from_value() ã®ä½¿ã„æ–¹
  - map_err() ã§ã‚¨ãƒ©ãƒ¼ã‚’ CodecError ã«ãƒ©ãƒƒãƒ—
  - thiserror ã® #[error("...")] ã§æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

- **ãƒ†ã‚¹ãƒˆçµæœ:**
  ```
  test typed::codec::tests::test_encode_decode_roundtrip ... ok
  test typed::codec::tests::test_decode_invalid_payload ... ok
  ```

#### 4. v1 ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§å¯¾å¿œï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰
- **å•é¡Œ:** v1 ã®ã‚³ãƒ¼ãƒ‰ãŒæ–°ã—ã„ ULID ãƒ™ãƒ¼ã‚¹ã® Id ã¨äº’æ›æ€§ãŒãªãã€ãƒ†ã‚¹ãƒˆãŒå¤±æ•—
- **è§£æ±ºç­–:**
  - ids.rs ã« #[deprecated] ãª new() ã¨ as_u64() ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
  - queue/memory.rs ã§ u64 â†’ u128 ã¸ã®ã‚­ãƒ£ã‚¹ãƒˆè¿½åŠ 

- **å®Ÿè£…å†…å®¹:**
  ```rust
  // ids.rs
  #[deprecated(note = "Use from_ulid() or IdGenerator instead. This is for v1 compatibility only.")]
  pub fn new(value: u128) -> Self {
      let bytes = value.to_be_bytes();
      let ulid = Ulid::from_bytes(bytes);
      Self::from_ulid(ulid)
  }

  #[deprecated(note = "This is for v1 compatibility only.")]
  pub fn as_u64(&self) -> u64 {
      let bytes = self.ulid.to_bytes();
      u64::from_be_bytes([bytes[8], bytes[9], bytes[10], bytes[11],
                          bytes[12], bytes[13], bytes[14], bytes[15]])
  }
  ```

- **å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ:**
  - v1/v2 ã®å…±å­˜æˆ¦ç•¥: #[deprecated] ã‚’ä½¿ã£ã¦æ®µéšçš„ã«ç§»è¡Œ
  - å‹å¤‰æ›ã®æ³¨æ„ç‚¹: u64 â†’ u128 ã¯ `as u128` ã§ç°¡å˜ã«ã‚­ãƒ£ã‚¹ãƒˆã§ãã‚‹

### æœ€çµ‚ãƒ†ã‚¹ãƒˆçµæœ

#### typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“
```
running 7 tests
test typed::codec::tests::test_encode_decode_roundtrip ... ok
test typed::codec::tests::test_decode_invalid_payload ... ok
test typed::registry::tests::test_different_task_types ... ok
test typed::registry::tests::test_register_and_get ... ok
test typed::handler::tests::test_typed_handler ... ok
test typed::registry::tests::test_double_registration ... ok
test typed::registry::tests::test_registered_types ... ok

test result: ok. 7 passed; 0 failed; 0 ignored; 0 measured; 58 filtered out
```

#### cargo check
```
warning: `weaver-core` (lib) generated 89 warnings
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.03s
```

âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸï¼ˆwarnings ã¯ v1 ã® deprecated ã‚³ãƒ¼ãƒ‰ã®ã¿ï¼‰

### çµ‚äº†æ™‚åˆ»
2026-01-07 ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†

---

## ğŸ“ å­¦ã‚“ã ã“ã¨

### 1. TypedRegistry::register ã®è©³ç´°è§£èª¬

ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã«ä¸€è¡Œãšã¤è§£èª¬ã‚’è¡Œã£ãŸå†…å®¹ã‚’ã¾ã¨ã‚ã¾ã™ï¼š

```rust
pub fn register<T: Task, H: Handler<T> + 'static>(
    &mut self,
    handler: H,
) -> Result<(), RegistryError> {
    // 1è¡Œç›®: T::TYPE ã§ task_type ã‚’å–å¾—
    let task_type = T::TYPE;

    // 2-4è¡Œç›®: äºŒé‡ç™»éŒ²ãƒã‚§ãƒƒã‚¯
    if self.handlers.contains_key(task_type) {
        return Err(RegistryError::AlreadyRegistered(task_type.to_string()));
    }

    // 5-8è¡Œç›®: TypedHandler ã§ãƒ©ãƒƒãƒ—
    let typed_handler = TypedHandler {
        handler,
        _marker: PhantomData::<T>,
    };

    // 9è¡Œç›®: HashMap ã«æŒ¿å…¥
    self.handlers.insert(task_type.to_string(), Arc::new(typed_handler));

    // 10è¡Œç›®: æˆåŠŸã‚’è¿”ã™
    Ok(())
}
```

**å„è¡Œã®å½¹å‰²:**

1. **`let task_type = T::TYPE;`**
   - å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ T ã‹ã‚‰ associated constant TYPE ã‚’å–å¾—
   - ä¾‹: `TestTask::TYPE` â†’ `"test.task.create.v1"`
   - å‹å®‰å…¨æ€§ã®éµï¼šã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã« T ãŒæ±ºã¾ã£ã¦ã„ã‚‹ã®ã§ã€TYPE ã‚‚æ±ºã¾ã‚‹

2. **äºŒé‡ç™»éŒ²ãƒã‚§ãƒƒã‚¯**
   - `contains_key()` ã§æ—¢å­˜ã®ç™»éŒ²ã‚’ç¢ºèª
   - ä¸Šæ›¸ãã§ã¯ãªãã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã“ã¨ã§ã€æ„å›³ã—ãªã„ç½®ãæ›ãˆã‚’é˜²ã
   - fail-fast è¨­è¨ˆï¼ˆå•é¡Œã‚’æ—©æœŸã«æ¤œå‡ºï¼‰

3. **TypedHandler ã§ãƒ©ãƒƒãƒ—**
   - `handler` ã®æ‰€æœ‰æ¨©ã‚’ç§»å‹•ï¼ˆmoveï¼‰
   - `PhantomData<T>` ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å‹æƒ…å ±ã‚’ä¿æŒ
   - å®Ÿè¡Œæ™‚ã®ãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆã¯ã‚¼ãƒ­

4. **HashMap ã«æŒ¿å…¥**
   - `Arc::new()` ã§å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆä»˜ããƒã‚¤ãƒ³ã‚¿ã«ãƒ©ãƒƒãƒ—
   - è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰åŒã˜ Handler ã‚’å…±æœ‰å¯èƒ½
   - `task_type.to_string()` ã§ã‚­ãƒ¼ã‚’ String ã«å¤‰æ›ï¼ˆHashMap ã¯æ‰€æœ‰å‹ãŒå¿…è¦ï¼‰

5. **æˆåŠŸã‚’è¿”ã™**
   - `Ok(())` ã§ unit type ã‚’è¿”ã™
   - ã€ŒæˆåŠŸã—ãŸãŒã€ç‰¹ã«è¿”ã™å€¤ã¯ãªã„ã€ã¨ã„ã†æ„å‘³

**ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å…¨ä½“:**
```
register::<TestTask>(TestTaskHandler)
         â†“
T::TYPE ã§ "test.task.v1" ã‚’å–å¾—
         â†“
äºŒé‡ç™»éŒ²ãƒã‚§ãƒƒã‚¯
         â†“
Handler<TestTask> â†’ TypedHandler<TestTask, TestTaskHandler>
         â†“
TypedHandler ã¯ DynHandler trait ã‚’å®Ÿè£…
         â†“
Arc ã§ãƒ©ãƒƒãƒ—ã—ã¦ HashMap ã«æ ¼ç´
         â†“
HashMap<String, Arc<dyn DynHandler>>
{
  "test.task.v1" â†’ Arc<TypedHandler<...>>
}
```

### 2. Type Erasure ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Œå…¨ãªå®Ÿè£…

**äºŒå±¤æ§‹é€ ã®å®Ÿç¾:**
```
åˆ©ç”¨è€…å´ï¼ˆå‹ä»˜ãï¼‰              å†…éƒ¨ï¼ˆå‹æ¶ˆå»ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Task trait                    â†’ DynHandler trait
Handler<T: Task>              â†’ Box<dyn DynHandler>
TypedRegistry::register<T>()  â†’ HashMap<String, Arc<dyn DynHandler>>
```

**ãªãœäºŒå±¤æ§‹é€ ãŒå¿…è¦ã‹:**
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã®å‹å®‰å…¨æ€§ï¼ˆtask_type ã¨ Handler ã®å¯¾å¿œã‚’ä¿è¨¼ï¼‰
- å®Ÿè¡Œæ™‚ã®æŸ”è»Ÿæ€§ï¼ˆå‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã§è¤‡æ•°ã® Handler ã‚’ HashMap ã«æ ¼ç´ï¼‰

### 2. HashMap ã§ã® Arc ã®æ´»ç”¨

**Arc ã‚’ä½¿ã†ç†ç”±:**
- get() ã§è¿”ã™éš›ã«ã€å€¤å…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼ã›ãšå‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã ã‘ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
- è¤‡æ•°ã® Worker ãŒåŒã˜ Handler ã‚’å…±æœ‰ã§ãã‚‹
- ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ï¼ˆArc ã¯ Send + Syncï¼‰

```rust
pub fn get(&self, task_type: &str) -> Option<Arc<dyn DynHandler>> {
    self.handlers.get(task_type).cloned()  // Arc::clone() ãŒå‘¼ã°ã‚Œã‚‹
}
```

### 3. thiserror ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å®šç¾©:**
```rust
#[derive(Debug, thiserror::Error)]
pub enum CodecError {
    #[error("Serialization failed: {0}")]
    SerializeFailed(String),

    #[error("Deserialization failed: {0}")]
    DeserializeFailed(String),
}
```

- Display trait ãŒè‡ªå‹•å®Ÿè£…ã•ã‚Œã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å…·ä½“çš„ãªæƒ…å ±ã‚’å«ã‚ã‚‹
- ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“ã«ãªã‚‹

### 4. v1/v2 å…±å­˜æˆ¦ç•¥

**#[deprecated] ã«ã‚ˆã‚‹æ®µéšçš„ç§»è¡Œ:**
```rust
#[deprecated(note = "Use from_ulid() or IdGenerator instead.")]
pub fn new(value: u128) -> Self { ... }
```

- å¤ã„ API ã‚’å³åº§ã«å‰Šé™¤ã›ãšã€ã¾ãš deprecated ã«ãƒãƒ¼ã‚¯
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«è­¦å‘ŠãŒå‡ºã‚‹ãŸã‚ã€ç§»è¡Œã‚’ä¿ƒã›ã‚‹
- ç§»è¡ŒæœŸé–“ã‚’è¨­ã‘ã‚‹ã“ã¨ã§ã€æ®µéšçš„ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°å¯èƒ½

### 5. async ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹

**#[tokio::test] ã®ä½¿ç”¨:**
```rust
#[tokio::test]
async fn test_typed_handler() {
    let handler = TestTaskHandler;
    let typed_handler = TypedHandler::<TestTask, _>::new(handler);

    let payload = json!({ "value": 100 });
    let outcome = typed_handler.handle_dyn(payload).await.unwrap();
    assert!(outcome.kind == OutcomeKind::Success);
}
```

- #[tokio::test] ãŒè‡ªå‹•çš„ã« tokio ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’èµ·å‹•
- .await ã‚’ä½¿ã£ãŸéåŒæœŸå‡¦ç†ã®ãƒ†ã‚¹ãƒˆ

---

## ğŸ” ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆ

### è‰¯ã‹ã£ãŸç‚¹

1. **å‹å®‰å…¨æ€§ã®å¾¹åº•:**
   - Task trait ã® const TYPE ã«ã‚ˆã‚Šã€task_type ã¨å‹ãŒç´ã¥ã
   - Handler<T> ã«ã‚ˆã‚Šã€Handler ãŒæ‰±ã† Task å‹ãŒæ˜ç¢º
   - ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã« typo ãŒæ¤œå‡ºã§ãã‚‹

2. **ãƒ†ã‚¹ãƒˆã®å……å®Ÿ:**
   - æ­£å¸¸ç³»ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—ã€ç™»éŒ²ãƒ»å–å¾—ï¼‰
   - ç•°å¸¸ç³»ï¼ˆäºŒé‡ç™»éŒ²ã€ç„¡åŠ¹ãª payloadï¼‰
   - å¢ƒç•Œæ¡ä»¶ï¼ˆç•°ãªã‚‹ Task å‹ã®æ··åœ¨ï¼‰

3. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ˜ç¢ºã•:**
   - ä½•ãŒå¤±æ•—ã—ãŸã‹ãŒä¸€ç›®ã§ã‚ã‹ã‚‹
   - ã‚¨ãƒ©ãƒ¼ã« task_type ãªã©ã®å…·ä½“çš„ãªæƒ…å ±ã‚’å«ã‚ã‚‹

### æ”¹å–„ã®ä½™åœ°

1. **ãƒ†ã‚¹ãƒˆç”¨ã®å‹ã®æ•´ç†:**
   - TestTask, AnotherTestTask ã¯å°†æ¥çš„ã« #[cfg(test)] ã§æ•´ç†
   - æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã¨ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®åˆ†é›¢

2. **NotFound ã‚¨ãƒ©ãƒ¼ã®è¿½åŠ :**
   - RegistryError::NotFound ã‚’è¿½åŠ ã—ã¦ã€get() ã§ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã“ã¨ã‚‚æ¤œè¨
   - ç¾çŠ¶ã¯ Option<Arc<dyn DynHandler>> ã‚’è¿”ã—ã¦ã„ã‚‹

---

## ğŸ“Š PR-3 ã®å®ŒæˆçŠ¶æ³

### å®Ÿè£…å®Œäº†

- âœ… Task trait ã®å®šç¾©
- âœ… Handler<T> trait ã®å®šç¾©
- âœ… DynHandler trait ã®å®šç¾©
- âœ… TypedHandler adapter ã®å®Ÿè£…
- âœ… TypedRegistry ã®å®Ÿè£…
- âœ… PayloadCodec ã®å®Ÿè£…
- âœ… ãƒ†ã‚¹ãƒˆã®è¿½åŠ ï¼ˆ7å€‹ï¼‰
- âœ… cargo check æˆåŠŸ
- âœ… cargo test æˆåŠŸ

### æœªå®Ÿè£…ï¼ˆæ¬¡å›ä»¥é™ï¼‰

- â³ app/builder.rs - expect_tasks() ã®å®Ÿè£…ï¼ˆPR-5 ã§å¯¾å¿œï¼‰
- â³ DispatchStrategyï¼ˆPR-4 ã§å¯¾å¿œï¼‰

---

## ğŸ”— å‚è€ƒè³‡æ–™

- **v2 è¦ä»¶ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `dev/docs/requirements/2026_01_03_weaver_requirements.md` 5ç« 
- **ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ**: `dev/learning/tasks.md` PR-3
- **CLAUDE.md**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **å‰å›ã®å­¦ç¿’ãƒ­ã‚°**: `dev/learning/learning_2026_01_06.md`

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### PR-3 å®Œäº† ğŸ‰

TypedTask API ã®å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼

### æ¬¡ã® PR

- **PR-4: DispatchStrategyï¼ˆtraitï¼‰+ DirectDispatch**
  - DispatchStrategy trait ã®å®šç¾©
  - DirectDispatch å®Ÿè£…ï¼ˆ1:1 ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
  - App ã¸ã®çµ±åˆ

- **PR-5: èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰**
  - AppBuilder::expect_tasks() ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
  - build() æ™‚ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
  - fail-fast è¨­è¨ˆ

- **PR-6: InMemoryDeliveryQueueï¼ˆé–‹ç™ºç”¨ï¼‰**
  - DeliveryQueue trait ã®å®šç¾©
  - InMemoryDeliveryQueue å®Ÿè£…
  - PG/Redis ãªã—ã§å‹•ä½œç¢ºèª

---

## ğŸ“ˆ å­¦ç¿’ã®é€²æ—

### Week 1 ã®é€²æ—

- âœ… PR-1: Module Tree ç§»è¡Œï¼ˆ2026-01-04 å®Œäº†ï¼‰
- âœ… PR-2: ULID Newtypes + IdGenerator/Clockï¼ˆ2026-01-04 å®Œäº†ï¼‰
- âœ… **PR-3: Typed Task APIï¼ˆ2026-01-07 å®Œäº†ï¼‰** â† ä»Šæ—¥å®Œæˆï¼
- â³ PR-4: DispatchStrategyï¼ˆtraitï¼‰+ DirectDispatch
- â³ PR-5: èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰
- â³ PR-6: InMemoryDeliveryQueueï¼ˆé–‹ç™ºç”¨ï¼‰

**é€²æ—ç‡:** 3/6 (50%)

---

## ğŸ’­ æ‰€æ„Ÿ

### å®Ÿè£…ã‚’é€šã˜ã¦

TypedTask API ã®å®Ÿè£…ã‚’é€šã˜ã¦ã€Rust ã®å‹ã‚·ã‚¹ãƒ†ãƒ ã®å¼·åŠ›ã•ã‚’å®Ÿæ„Ÿã—ã¾ã—ãŸï¼š

1. **Type Erasure ãƒ‘ã‚¿ãƒ¼ãƒ³**: Generic å‹ã‹ã‚‰ trait object ã¸ã®å¤‰æ›ã«ã‚ˆã‚Šã€å‹å®‰å…¨æ€§ã¨æŸ”è»Ÿæ€§ã‚’ä¸¡ç«‹ã§ãã‚‹
2. **Associated Constants**: Task trait ã® const TYPE ã«ã‚ˆã‚Šã€å‹ã¨ãƒªãƒ†ãƒ©ãƒ«ã‚’çµã³ã¤ã‘ã‚‹ã“ã¨ã§ã€typo ã‚’é˜²ã’ã‚‹
3. **Arc ã«ã‚ˆã‚‹å…±æœ‰æ‰€æœ‰æ¨©**: å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã«ã‚ˆã‚Šã€è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«å‚ç…§ã§ãã‚‹

### ä»Šå¾Œã®å­¦ç¿’

æ¬¡ã¯ DispatchStrategy ã‚’å®Ÿè£…ã—ã¦ã€å°†æ¥ã®æ‹¡å¼µï¼ˆRule/Agent dispatchï¼‰ã«å‚™ãˆãŸæŠ½è±¡åŒ–ã‚’å­¦ã³ã¾ã™ã€‚

TypedTask API ã§å­¦ã‚“ã  Type Erasure ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ä»–ã®å ´é¢ã§ã‚‚å¿œç”¨ã§ããã†ã§ã™ï¼

---

## ğŸ“‹ æ¬¡å›ã¸ã®å¼•ãç¶™ãäº‹é …

### å®Œäº†ã—ãŸå†…å®¹

1. **TypedTask APIï¼ˆPR-3ï¼‰** - å®Œå…¨å®Ÿè£…æ¸ˆã¿ âœ…
   - Task trait, Handler<T> trait, DynHandler trait
   - TypedRegistryï¼ˆHashMap<String, Arc<dyn DynHandler>>ï¼‰
   - PayloadCodecï¼ˆencode/decodeï¼‰
   - ãƒ†ã‚¹ãƒˆ 7 å€‹ï¼ˆå…¨ã¦æˆåŠŸï¼‰
   - v1 äº’æ›æ€§å¯¾å¿œï¼ˆId::new(), as_u64()ï¼‰

### æ¬¡å›ã®ä½œæ¥­

1. **PR-4: DispatchStrategyï¼ˆtraitï¼‰+ DirectDispatch**

   **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
   - `crates/weaver-core/src/ports/dispatch.rs` - DispatchStrategy trait ã®å®šç¾©
   - `crates/weaver-core/src/app/dispatch.rs` - DirectDispatch ã®å®Ÿè£…

   **å®Ÿè£…å†…å®¹:**
   - DispatchStrategy trait:
     ```rust
     pub trait DispatchStrategy {
         fn select_handler(
             &self,
             task_type: &str,
             meta: &TaskMeta
         ) -> Result<String, DispatchError>;
     }
     ```
   - DirectDispatch: task_type == handler_idï¼ˆ1:1 ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
   - AppBuilder ã¸ã®çµ±åˆï¼ˆstrategy ã‚’å·®ã—æ›¿ãˆå¯èƒ½ã«ï¼‰

   **å‚è€ƒè³‡æ–™:**
   - è¦ä»¶ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ 6ç« ã€ŒDispatchStrategyã€
   - tasks.md PR-4

2. **ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰çŠ¶æ…‹**
   - typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å®Œæˆæ¸ˆã¿
   - v1 ã®ã‚³ãƒ¼ãƒ‰ã¯ deprecated è­¦å‘ŠãŒå‡ºã‚‹ãŒã€å‹•ä½œã¯å•é¡Œãªã—
   - cargo check, cargo test ã¨ã‚‚ã«æˆåŠŸ

### æ³¨æ„äº‹é …

- typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆç”¨ã®å‹ï¼ˆTestTask, AnotherTestTaskï¼‰ã¯å°†æ¥çš„ã« #[cfg(test)] ã§æ•´ç†äºˆå®š
- v1 ã‚³ãƒ¼ãƒ‰ã¯æ®µéšçš„ã«å‰Šé™¤äºˆå®šï¼ˆã¾ãšã¯å‹•ä½œç¢ºèªã‚’å„ªå…ˆï¼‰
- PR-5ï¼ˆexpect_tasksï¼‰ã¯ PR-4 å®Œäº†å¾Œã«å®Ÿè£…

### å­¦ç¿’ã®ãƒã‚¤ãƒ³ãƒˆ

PR-4 ã§ã¯ä»¥ä¸‹ã‚’å­¦ã³ã¾ã™ï¼š
- Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…
- Trait ã«ã‚ˆã‚‹æŒ¯ã‚‹èˆã„ã®å·®ã—æ›¿ãˆ
- å°†æ¥ã®æ‹¡å¼µæ€§ã‚’è€ƒãˆãŸè¨­è¨ˆï¼ˆRule/Agent dispatch ã¸ã®æº–å‚™ï¼‰

---

## â³ PR-4: DispatchStrategyï¼ˆtraitï¼‰+ DirectDispatchï¼ˆå­¦ç¿’ã‚¿ã‚¹ã‚¯ï¼‰

### ğŸ“‹ ã‚¿ã‚¹ã‚¯ã®æ¦‚è¦
task_type ã‹ã‚‰ handler_id ã¸ã®è§£æ±ºã‚’æŠ½è±¡åŒ–ã—ã€å°†æ¥ã®æ‹¡å¼µï¼ˆRule/Agent dispatchï¼‰ã«å‚™ãˆã‚‹ã€‚v2 ã§ã¯ DirectDispatchï¼ˆ1:1 ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰ã‚’å®Ÿè£…ã€‚

### ğŸ¯ å­¦ç¿’ç›®æ¨™
ã“ã®ã‚¿ã‚¹ã‚¯ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã® Rust ã®æ¦‚å¿µã‚’å®Ÿè·µçš„ã«å­¦ã³ã¾ã™ï¼š
1. **Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³** - Trait ã«ã‚ˆã‚‹æŒ¯ã‚‹èˆã„ã®å·®ã—æ›¿ãˆ
2. **Future-proof design** - æ‹¡å¼µæ€§ã‚’è€ƒãˆãŸæŠ½è±¡åŒ–
3. **Object safety** - Trait ã®åˆ¶ç´„ã¨è¨­è¨ˆ

### ğŸ“ å®Ÿè£…ã™ã¹ãå†…å®¹

**å¤‰æ›´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:**
1. `crates/weaver-core/src/ports/dispatch.rs` - DispatchStrategy trait ã®ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©
2. `crates/weaver-core/src/impls/mod.rs` - impls ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
3. `crates/weaver-core/src/impls/dispatch.rs` - DirectDispatch å®Ÿè£…ï¼ˆæ–°è¦ä½œæˆï¼‰
4. `crates/weaver-core/src/lib.rs` - impls ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…¬é–‹

### âœ… æ©Ÿèƒ½è¦ä»¶

**1. DispatchStrategy traitï¼ˆports/dispatch.rsï¼‰**
- `select_handler(&self, task_type: &str) -> Result<String, WeaverError>` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©
- v2 æœ€å°ç‰ˆã§ã¯ task_type ã®ã¿ã‚’å¼•æ•°ã«å–ã‚‹ï¼ˆTaskMeta ã¯å°†æ¥ã®æ‹¡å¼µï¼‰
- object-safe ã§ã‚ã‚‹ã“ã¨ï¼ˆ&self, æˆ»ã‚Šå€¤ã¯ Result<String, ...>ï¼‰

**2. DirectDispatch structï¼ˆimpls/dispatch.rsï¼‰**
- DispatchStrategy trait ã‚’å®Ÿè£…
- select_handler() ã¯å˜ç´”ã« task_type.to_string() ã‚’è¿”ã™ï¼ˆ1:1 ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
- new() ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’æä¾›

**3. ãƒ†ã‚¹ãƒˆ**
- DirectDispatch ã®æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆ
- ç©ºæ–‡å­—åˆ—ã‚„ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆï¼ˆä»»æ„ï¼‰

### ğŸš¨ æŠ€è¡“çš„åˆ¶ç´„ï¼ˆéå¸¸ã«é‡è¦ï¼‰

1. **Object safety ã‚’ä¿ã¤**
   - ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚’ä½¿ã‚ãšã€å…·ä½“çš„ãªå‹ï¼ˆ&str, Stringï¼‰ã‚’ä½¿ã†
   - &self ã‚’ä½¿ã†ï¼ˆself ã‚„ &mut self ã¯å¯èƒ½ã ãŒã€ä»Šå›ã¯ &self ã§ååˆ†ï¼‰

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - v2 æœ€å°ç‰ˆã§ã¯ã€DirectDispatch ã¯å¸¸ã« Ok ã‚’è¿”ã™ï¼ˆå¤±æ•—ã—ãªã„ï¼‰
   - å°†æ¥ã®æ‹¡å¼µï¼ˆRuleDispatchï¼‰ã§ã‚¨ãƒ©ãƒ¼ãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€Result ã‚’è¿”ã™è¨­è¨ˆã«ã™ã‚‹

3. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ**
   - impls/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ–°è¦ä½œæˆ
   - impls/mod.rs ã§ dispatch ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¬é–‹
   - lib.rs ã§ impls ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¬é–‹

### ğŸ’¡ å®Ÿè£…ã®ãƒ’ãƒ³ãƒˆ

<details>
<summary>1. DispatchStrategy trait ã®å®šç¾©ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>

```rust
/// DispatchStrategy ã¯ task_type ã‚’ handler_id ã«è§£æ±º
///
/// # v2 ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
/// - DirectDispatch: 1:1 ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆtask_type == handler_idï¼‰
///
/// # å°†æ¥ã®æ‹¡å¼µ
/// - RuleDispatch: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°
/// - AgentDispatch: LLM ã«ã‚ˆã‚‹å‹•çš„ãƒãƒƒãƒ”ãƒ³ã‚°
pub trait DispatchStrategy {
    /// task_type ã‹ã‚‰ handler_id ã‚’é¸æŠ
    ///
    /// # å¼•æ•°
    /// - task_type: ã‚¿ã‚¹ã‚¯ã®å‹è­˜åˆ¥å­ï¼ˆä¾‹: "test.task.v1"ï¼‰
    ///
    /// # æˆ»ã‚Šå€¤
    /// - Ok(handler_id): è§£æ±ºæˆåŠŸ
    /// - Err: è§£æ±ºå¤±æ•—ï¼ˆv2 ã§ã¯ DirectDispatch ã¯å¸¸ã« Okï¼‰
    fn select_handler(&self, task_type: &str) -> Result<String, WeaverError>;
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- &self ã‚’ä½¿ã†ã“ã¨ã§ object-safe ã«ãªã‚‹
- Result ã‚’è¿”ã™ã“ã¨ã§ã€å°†æ¥ã®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œ
- å¼•æ•°ã¯ &strï¼ˆå€Ÿç”¨ï¼‰ã€æˆ»ã‚Šå€¤ã¯ Stringï¼ˆæ‰€æœ‰ï¼‰
</details>

<details>
<summary>2. DirectDispatch ã®å®Ÿè£…ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>

```rust
/// DirectDispatch ã¯ task_type ã¨ handler_id ã‚’ 1:1 ã§ãƒãƒƒãƒ”ãƒ³ã‚°
#[derive(Debug, Clone, Default)]
pub struct DirectDispatch;

impl DirectDispatch {
    pub fn new() -> Self {
        Self
    }
}

impl DispatchStrategy for DirectDispatch {
    fn select_handler(&self, task_type: &str) -> Result<String, WeaverError> {
        // task_type ã‚’ãã®ã¾ã¾ handler_id ã¨ã—ã¦è¿”ã™
        Ok(task_type.to_string())
    }
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—ã® structï¼ˆZero-sized typeï¼‰
- Default trait ã‚’ derive ã—ã¦ new() ã®å®Ÿè£…ã‚’ç°¡ç´ åŒ–
- to_string() ã§ &str ã‹ã‚‰ String ã¸ã®å¤‰æ›
</details>

<details>
<summary>3. ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_direct_dispatch() {
        let dispatch = DirectDispatch::new();
        let handler_id = dispatch.select_handler("test.task.v1").unwrap();
        assert_eq!(handler_id, "test.task.v1");
    }
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- #[cfg(test)] ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®ã¿ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
- unwrap() ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ç°¡æ½”ã«ï¼ˆæœ¬ç•ªã§ã¯ä½¿ã‚ãªã„ï¼‰
</details>

### ğŸ” å®Ÿè£…å¾Œã®ç¢ºèªäº‹é …

- [ ] cargo check ãŒæˆåŠŸã™ã‚‹
- [ ] cargo test ãŒæˆåŠŸã™ã‚‹ï¼ˆæ–°ã—ã„ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ï¼‰
- [ ] ports/dispatch.rs ã® TODO(PR-4) ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
- [ ] impls/dispatch.rs ãŒä½œæˆã•ã‚Œã€DirectDispatch ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] impls ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ lib.rs ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹

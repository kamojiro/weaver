# Weaver v2 å­¦ç¿’è¨˜éŒ² - 2026-01-11

## ğŸ“… ä»Šæ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³

**é–‹å§‹æ—¥æ™‚:** 2026-01-11
**ãƒ•ã‚§ãƒ¼ã‚º:** Week 1 - éª¨æ ¼ã¨ Typed APIï¼ˆæ­£ã—ã•ã®åœŸå°ï¼‰
**ã‚¿ã‚¹ã‚¯:** PR-4: DispatchStrategyï¼ˆtraitï¼‰+ DirectDispatchï¼ˆå®Œæˆï¼‰

---

## ğŸ¯ ä»Šæ—¥ã®ç›®æ¨™

- [x] PR-4: DispatchStrategy trait ã®å®šç¾©
- [x] DirectDispatch ã®å®Ÿè£…
- [x] impls ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ•´å‚™
- [x] ãƒ†ã‚¹ãƒˆä½œæˆã¨å‹•ä½œç¢ºèª
- [x] typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® TODO ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰

---

## ğŸ“ å®Ÿè£…ãƒ¡ãƒ¢

### é–‹å§‹æ™‚åˆ»
2026-01-11 ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹

### å®Ÿè£…ã®æµã‚Œ

#### 1. DispatchStrategy trait ã®å®šç¾©ï¼ˆports/dispatch.rsï¼‰

**å®Ÿè£…å†…å®¹:**
- `select_handler(&self, task_type: &str) -> Result<String, WeaverError>` ãƒ¡ã‚½ãƒƒãƒ‰ã®å®šç¾©
- object-safe ãª trait è¨­è¨ˆï¼ˆã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ãªã—ã€&self ã‚’ä½¿ç”¨ï¼‰
- å°†æ¥ã®æ‹¡å¼µï¼ˆRuleDispatch, AgentDispatchï¼‰ã‚’è¦‹è¶Šã—ãŸæŠ½è±¡åŒ–

**å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ:**
- **Object safety ã®åˆ¶ç´„**: trait object ã¨ã—ã¦ä½¿ã†ãŸã‚ã€ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚’é¿ã‘ã‚‹
- **å€Ÿç”¨ vs æ‰€æœ‰**: å…¥åŠ›ã¯å€Ÿç”¨ï¼ˆ`&str`ï¼‰ã€å‡ºåŠ›ã¯æ‰€æœ‰ï¼ˆ`String`ï¼‰ã§å‘¼ã³å‡ºã—å´ãŒè‡ªç”±ã«ä½¿ãˆã‚‹
- **æ‹¡å¼µæ€§ã®è€ƒæ…®**: v2 ã§ã¯å¤±æ•—ã—ãªã„ãŒã€å°†æ¥ã®æ‹¡å¼µã®ãŸã‚ Result ã‚’è¿”ã™è¨­è¨ˆ

#### 2. DirectDispatch ã®å®Ÿè£…ï¼ˆimpls/dispatch.rsï¼‰

**å®Ÿè£…å†…å®¹:**
- `pub struct DirectDispatch;` - ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—ã® structï¼ˆZero-sized typeï¼‰
- `new()` ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å®Ÿè£…
- `DispatchStrategy` trait ã®å®Ÿè£…ï¼ˆ1:1 ãƒãƒƒãƒ”ãƒ³ã‚°: `task_type.to_string()`ï¼‰
- `Default` trait ã®å®Ÿè£…
- ãƒ†ã‚¹ãƒˆ 1 å€‹ã®è¿½åŠ ï¼ˆtest_direct_dispatchï¼‰

**å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ:**
- **Zero-sized type (ZST)**: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ãŸã‚ã€ãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆãŒã‚¼ãƒ­
- **Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³**: trait ã«ã‚ˆã‚‹æŒ¯ã‚‹èˆã„ã®å·®ã—æ›¿ãˆ
- **å˜ç´”ãªå®Ÿè£…**: DirectDispatch ã¯ task_type ã‚’ãã®ã¾ã¾è¿”ã™ã ã‘

**ã‚³ãƒ¼ãƒ‰:**
```rust
pub struct DirectDispatch;

impl DirectDispatch {
    pub fn new() -> Self {
        Self
    }
}

impl DispatchStrategy for DirectDispatch {
    fn select_handler(&self, task_type: &str) -> Result<String, WeaverError> {
        Ok(task_type.to_string())
    }
}

impl Default for DirectDispatch {
    fn default() -> Self {
        Self::new()
    }
}
```

#### 3. impls ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ•´å‚™

**å®Ÿè£…å†…å®¹:**
- `impls/mod.rs` ã§ dispatch ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¬é–‹
- DirectDispatch ã‚’ re-exportï¼ˆ`pub use self::dispatch::DirectDispatch;`ï¼‰
- TODO ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤

**å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ:**
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã®æ•´ç†: impls/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é–‹ç™ºç”¨å®Ÿè£…ã‚’é›†ç´„
- å…¬é–‹ API ã®è¨­è¨ˆ: ä¸»è¦ãªå‹ã‚’ re-export ã—ã¦ä½¿ã„ã‚„ã™ã

#### 4. typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

**å®Ÿè£…å†…å®¹:**
- registry.rs, codec.rs, handler.rs, task.rs ã® TODO(human) ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤
- "å®Ÿè£…äºˆå®š" ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰Šé™¤
- ã‚³ãƒ¡ãƒ³ãƒˆã®æ•´ç†

**å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ:**
- å®Ÿè£…å®Œäº†å¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®é‡è¦æ€§
- ä¸è¦ãª TODO ã‚³ãƒ¡ãƒ³ãƒˆã¯å‰Šé™¤ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚„ã™ã

### ãƒ†ã‚¹ãƒˆçµæœ

#### DirectDispatch ã®ãƒ†ã‚¹ãƒˆ
```
test impls::dispatch::tests::test_direct_dispatch ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured
```

#### typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆï¼ˆå†ç¢ºèªï¼‰
```
test result: ok. 7 passed; 0 failed; 0 ignored; 0 measured
```

#### cargo check
```
warning: `weaver-core` (lib) generated 89 warnings
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.04s
```

âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸï¼ˆwarnings ã¯ v1 ã® deprecated ã‚³ãƒ¼ãƒ‰ã®ã¿ï¼‰

### çµ‚äº†æ™‚åˆ»
2026-01-11 ã‚»ãƒƒã‚·ãƒ§ãƒ³é€²è¡Œä¸­

---

## ğŸ“ å­¦ã‚“ã ã“ã¨

### 1. Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…

**Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯:**
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚„æŒ¯ã‚‹èˆã„ã‚’ trait ã§æŠ½è±¡åŒ–ã—ã€å®Ÿè£…ã‚’å·®ã—æ›¿ãˆå¯èƒ½ã«ã™ã‚‹
- v2 ã§ã¯ DirectDispatchï¼ˆ1:1 ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰ã®ã¿
- å°†æ¥ã¯ RuleDispatchï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼‰ã‚„ AgentDispatchï¼ˆLLM ã«ã‚ˆã‚‹å‹•çš„ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰ã‚’è¿½åŠ äºˆå®š

**å®Ÿè£…ã®è¦ç‚¹:**
```rust
// æŠ½è±¡åŒ–ï¼ˆtraitï¼‰
pub trait DispatchStrategy {
    fn select_handler(&self, task_type: &str) -> Result<String, WeaverError>;
}

// å®Ÿè£…ï¼ˆstruct + trait implï¼‰
pub struct DirectDispatch;

impl DispatchStrategy for DirectDispatch {
    fn select_handler(&self, task_type: &str) -> Result<String, WeaverError> {
        Ok(task_type.to_string())
    }
}
```

**åˆ©ç‚¹:**
- **Open/Closed Principle**: æ‹¡å¼µã«é–‹ã„ã¦ã€ä¿®æ­£ã«é–‰ã˜ã¦ã„ã‚‹
- **å·®ã—æ›¿ãˆå¯èƒ½**: å®Ÿè¡Œæ™‚ã«ç•°ãªã‚‹ strategy ã‚’é¸æŠå¯èƒ½
- **ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„**: ãƒ¢ãƒƒã‚¯ strategy ã‚’ç°¡å˜ã«ä½œæˆã§ãã‚‹

### 2. Object-safe ãª trait è¨­è¨ˆ

**Object safety ã¨ã¯:**
- trait object (`Box<dyn Trait>`, `Arc<dyn Trait>`) ã¨ã—ã¦ä½¿ãˆã‚‹ãŸã‚ã®åˆ¶ç´„
- ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚„ `Self` ã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä½¿ãˆãªã„

**DispatchStrategy ãŒ object-safe ãªç†ç”±:**
```rust
pub trait DispatchStrategy {
    fn select_handler(&self, task_type: &str) -> Result<String, WeaverError>;
    //              ^^^^^ &self ã‚’ä½¿ç”¨
    //                           ^^^^^ å…·ä½“çš„ãªå‹ï¼ˆã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ãªã—ï¼‰
}
```

**object-safe ã§ãªã„ä¾‹:**
```rust
// âŒ ã“ã‚Œã¯ object-safe ã§ãªã„
pub trait BadDispatchStrategy {
    fn select_handler<T: Task>(&self, task: T) -> Result<String, WeaverError>;
    //                ^^^^^^^^^ ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã¯ NG
}
```

**ä½¿ç”¨ä¾‹:**
```rust
// trait object ã¨ã—ã¦ä½¿ãˆã‚‹
let strategy: Box<dyn DispatchStrategy> = Box::new(DirectDispatch::new());
let handler_id = strategy.select_handler("my_task")?;
```

### 3. Zero-sized type (ZST) ã®æ´»ç”¨

**ZST ã¨ã¯:**
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒãŸãªã„ struct
- ãƒ¡ãƒ¢ãƒªã‚µã‚¤ã‚ºãŒ 0 ãƒã‚¤ãƒˆ
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒæœ€é©åŒ–ã—ã‚„ã™ã„

**DirectDispatch ã¯ ZST:**
```rust
pub struct DirectDispatch; // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—

// ãƒ¡ãƒ¢ãƒªã‚µã‚¤ã‚ºã¯ 0
assert_eq!(std::mem::size_of::<DirectDispatch>(), 0);

// ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆã®ã‚³ã‚¹ãƒˆã‚‚ã‚¼ãƒ­
let dispatcher = DirectDispatch::new(); // ã‚³ã‚¹ãƒˆ: 0
```

**ZST ã®åˆ©ç‚¹:**
- ãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆãªã—
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã®ã‚³ã‚¹ãƒˆãªã—
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«ã‚ˆã‚‹æœ€é©åŒ–ãŒåŠ¹ãã‚„ã™ã„

**å°†æ¥ã®æ‹¡å¼µã¨ã®å¯¾æ¯”:**
```rust
// DirectDispatch: ZSTï¼ˆãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆ 0ï¼‰
pub struct DirectDispatch;

// RuleDispatchï¼ˆå°†æ¥ï¼‰: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚ã‚Šï¼ˆãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆã‚ã‚Šï¼‰
pub struct RuleDispatch {
    rules: HashMap<String, String>, // ãƒ¡ãƒ¢ãƒªã‚’æ¶ˆè²»
}
```

### 4. å€Ÿç”¨ï¼ˆ&strï¼‰ã¨æ‰€æœ‰ï¼ˆStringï¼‰ã®ä½¿ã„åˆ†ã‘

**å…¥åŠ›ã¯å€Ÿç”¨:**
```rust
fn select_handler(&self, task_type: &str) -> Result<String, WeaverError>
//                                ^^^^ å€Ÿç”¨ã§å—ã‘å–ã‚‹
```
- å‘¼ã³å‡ºã—å´ãŒæ‰€æœ‰æ¨©ã‚’ä¿æŒã—ãŸã¾ã¾
- ã‚³ãƒ”ãƒ¼ä¸è¦ã§åŠ¹ç‡çš„

**å‡ºåŠ›ã¯æ‰€æœ‰:**
```rust
fn select_handler(&self, task_type: &str) -> Result<String, WeaverError>
//                                                   ^^^^^^ æ‰€æœ‰æ¨©ã‚’æ¸¡ã™
```
- å‘¼ã³å‡ºã—å´ãŒè‡ªç”±ã«ä½¿ãˆã‚‹
- å€Ÿç”¨ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ å•é¡Œã‚’å›é¿

**å®Ÿè£…å†…ã§ã®å¤‰æ›:**
```rust
Ok(task_type.to_string())
// ^^^^^^^^^^^^^^^^^ &str â†’ String ã«å¤‰æ›ï¼ˆæ‰€æœ‰æ¨©ã‚’ä½œã‚‹ï¼‰
```

### 5. Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ Type Erasure ã®çµ„ã¿åˆã‚ã›

**TypedRegistry ã¨ DispatchStrategy ã®é¡ä¼¼æ€§:**

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | TypedRegistry | DispatchStrategy |
|---------|--------------|-----------------|
| æŠ½è±¡åŒ– trait | DynHandler | DispatchStrategy |
| å…·ä½“å®Ÿè£… | TypedHandler<T> | DirectDispatch |
| æ ¼ç´æ–¹æ³• | HashMap<String, Arc<dyn DynHandler>> | Box<dyn DispatchStrategy> |
| ç”¨é€” | task_type â†’ Handler ã®è§£æ±º | task_type â†’ handler_id ã®è§£æ±º |

**å…±é€šãƒ‘ã‚¿ãƒ¼ãƒ³:**
1. trait ã§æŠ½è±¡åŒ–
2. object-safe ãªè¨­è¨ˆ
3. å®Ÿè¡Œæ™‚ã®æŸ”è»Ÿæ€§ï¼ˆå‹•çš„ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒï¼‰

---

## ğŸ” ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆ

### è‰¯ã‹ã£ãŸç‚¹

1. **Object-safe ãª trait è¨­è¨ˆ:**
   - ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚’é¿ã‘ã€å…·ä½“çš„ãªå‹ã‚’ä½¿ç”¨
   - trait object ã¨ã—ã¦ä½¿ãˆã‚‹è¨­è¨ˆ

2. **ZST ã®æ´»ç”¨:**
   - DirectDispatch ã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—
   - ãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆã‚¼ãƒ­

3. **æ‹¡å¼µæ€§ã®è€ƒæ…®:**
   - Result ã‚’è¿”ã™ã“ã¨ã§ã€å°†æ¥ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«å¯¾å¿œ
   - ç¾æ™‚ç‚¹ã§ã¯ Ok ã—ã‹è¿”ã•ãªã„ãŒã€RuleDispatch ã§ã¯ NotFound ãªã©ã®ã‚¨ãƒ©ãƒ¼ãŒå¿…è¦

4. **ãƒ†ã‚¹ãƒˆã®è¿½åŠ :**
   - test_direct_dispatch ã§åŸºæœ¬å‹•ä½œã‚’ç¢ºèª

### æ”¹å–„ã®ä½™åœ°ï¼ˆå°†æ¥ã®èª²é¡Œï¼‰

1. **è¿½åŠ ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹:**
   - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼ˆç©ºæ–‡å­—åˆ—ã€ç‰¹æ®Šæ–‡å­—ï¼‰ã®ãƒ†ã‚¹ãƒˆ
   - ãŸã ã—ã€DirectDispatch ã¯å˜ç´”ã™ãã¦ä¸è¦ã‹ã‚‚

2. **AppBuilder ã¸ã®çµ±åˆ:**
   - PR-5 ã¾ãŸã¯ PR-6 ã§ AppBuilder ã« DispatchStrategy ã‚’çµ„ã¿è¾¼ã‚€
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ DirectDispatch ã‚’ä½¿ç”¨

---

## ğŸ“Š PR-4 ã®å®ŒæˆçŠ¶æ³

### å®Ÿè£…å®Œäº†

- âœ… DispatchStrategy trait ã®å®šç¾©ï¼ˆports/dispatch.rsï¼‰
- âœ… DirectDispatch ã®å®Ÿè£…ï¼ˆimpls/dispatch.rsï¼‰
- âœ… impls ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ•´å‚™ï¼ˆimpls/mod.rsï¼‰
- âœ… DirectDispatch ã® re-export
- âœ… ãƒ†ã‚¹ãƒˆã®è¿½åŠ ï¼ˆ1å€‹ï¼‰
- âœ… cargo check æˆåŠŸ
- âœ… cargo test æˆåŠŸ
- âœ… typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### æœªå®Ÿè£…ï¼ˆæ¬¡å›ä»¥é™ï¼‰

- â³ AppBuilder ã¸ã®çµ±åˆï¼ˆPR-5 ã¾ãŸã¯å¾Œç¶šã® PR ã§å¯¾å¿œï¼‰
- â³ RuleDispatch ã®å®Ÿè£…ï¼ˆv3 ã§å¯¾å¿œäºˆå®šï¼‰
- â³ AgentDispatch ã®å®Ÿè£…ï¼ˆv3 ã§å¯¾å¿œäºˆå®šï¼‰

---

## ğŸ”— å‚è€ƒè³‡æ–™

- **v2 è¦ä»¶ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `dev/docs/requirements/2026_01_03_weaver_requirements.md` 6ç« 
- **ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ**: `dev/learning/tasks.md` PR-4
- **CLAUDE.md**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **å‰å›ã®å­¦ç¿’ãƒ­ã‚°**: `dev/learning/learning_2026_01_07.md`

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### PR-4 å®Œäº† ğŸ‰

DispatchStrategy + DirectDispatch ã®å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸï¼

### æ¬¡ã® PR

#### é¸æŠè‚¢ 1: PR-5 - èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰

**ç›®çš„:** ç™»éŒ²æ¼ã‚Œã‚’èµ·å‹•æ™‚ã«æ¤œçŸ¥ã—ã€fail-fast

**å®Ÿè£…å†…å®¹:**
- AppBuilder::expect_tasks() ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿½åŠ 
- build() æ™‚ã«ã€ŒæœŸå¾…é›†åˆ âŠ† ç™»éŒ²æ¸ˆã¿é›†åˆã€ã‚’ãƒã‚§ãƒƒã‚¯
- ä¸è¶³ãŒã‚ã‚Œã° panic ã¾ãŸã¯ Error

**å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:**
- Builder ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
- Fail-fast è¨­è¨ˆ
- é–‹ç™ºä½“é¨“ã®æ”¹å–„ï¼ˆæ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰

#### é¸æŠè‚¢ 2: PR-6 - InMemoryDeliveryQueueï¼ˆé–‹ç™ºç”¨ï¼‰

**ç›®çš„:** PG/Redis ãªã—ã§å‹•ä½œç¢ºèªã§ãã‚‹é–‹ç™ºç”¨ã‚­ãƒ¥ãƒ¼

**å®Ÿè£…å†…å®¹:**
- DeliveryQueue trait ã®å®šç¾©
- InMemoryDeliveryQueue å®Ÿè£…
- push/pop ã®å‹•ä½œç¢ºèª

**å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:**
- Trait ã«ã‚ˆã‚‹æŠ½è±¡åŒ–ï¼ˆRedis ã¨å·®ã—æ›¿ãˆå¯èƒ½ï¼‰
- Mutex/Condvar ã«ã‚ˆã‚‹åŒæœŸï¼ˆblocking popï¼‰
- Async ã§ã® blocking å‡¦ç†ã®æ‰±ã„

### æ¨å¥¨é †åº

**æ¬¡ã¯ PR-5ï¼ˆèµ·å‹•æ™‚æ¤œè¨¼ï¼‰ãŒãŠã™ã™ã‚:**
- AppBuilder ã«æ©Ÿèƒ½ã‚’è¿½åŠ 
- TypedRegistry ã¨ã®çµ±åˆ
- å®Ÿè£…ãŒæ¯”è¼ƒçš„ã‚·ãƒ³ãƒ—ãƒ«
- PR-6 ã‚ˆã‚Šå…ˆã«å®Œæˆã•ã›ã‚‹ã“ã¨ã§ã€é–‹ç™ºä½“é¨“ãŒå‘ä¸Š

ãã®å¾Œã€PR-6 ã§ DeliveryQueue ã‚’å®Ÿè£…ã—ã€Week 1 ã‚’å®Œäº†ã•ã›ã¾ã™ã€‚

---

## ğŸ“ˆ å­¦ç¿’ã®é€²æ—

### Week 1 ã®é€²æ—

- âœ… PR-1: Module Tree ç§»è¡Œï¼ˆ2026-01-04 å®Œäº†ï¼‰
- âœ… PR-2: ULID Newtypes + IdGenerator/Clockï¼ˆ2026-01-04 å®Œäº†ï¼‰
- âœ… PR-3: Typed Task APIï¼ˆ2026-01-07 å®Œäº†ï¼‰
- âœ… PR-4: DispatchStrategyï¼ˆtraitï¼‰+ DirectDispatchï¼ˆ2026-01-11 å®Œäº†ï¼‰
- âœ… **PR-5: èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰ï¼ˆ2026-01-11 å®Œäº†ï¼‰** â† ä»Šæ—¥å®Œæˆï¼
- â³ PR-6: InMemoryDeliveryQueueï¼ˆé–‹ç™ºç”¨ï¼‰â† æ¬¡ã¯ã“ã‚Œ

**é€²æ—ç‡:** 5/6 (83%)

---

## ğŸ’­ æ‰€æ„Ÿ

### å®Ÿè£…ã‚’é€šã˜ã¦

DispatchStrategy ã®å®Ÿè£…ã‚’é€šã˜ã¦ã€Rust ã«ãŠã‘ã‚‹æŠ½è±¡åŒ–ã®è¨­è¨ˆã‚’å­¦ã³ã¾ã—ãŸï¼š

1. **Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³**: trait ã§æŒ¯ã‚‹èˆã„ã‚’å·®ã—æ›¿ãˆå¯èƒ½ã«ã™ã‚‹è¨­è¨ˆ
2. **Object safety**: trait object ã¨ã—ã¦ä½¿ãˆã‚‹ãŸã‚ã®åˆ¶ç´„ã‚’ç†è§£
3. **Zero-sized type**: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã—ã® struct ãŒãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆ 0 ã§ã‚ã‚‹ã“ã¨

### ä»Šå¾Œã®å­¦ç¿’

æ¬¡ã¯ AppBuilder ã¸ã®çµ±åˆï¼ˆPR-5ï¼‰ã§ã€Builder ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’å­¦ã³ã¾ã™ã€‚

Week 1 ãŒã‚ã¨ 2 PR ã§å®Œäº†ã™ã‚‹ã®ã§ã€é †èª¿ã«é€²ã‚“ã§ã„ã¾ã™ï¼

---

## ğŸ“‹ æ¬¡å›ã¸ã®å¼•ãç¶™ãäº‹é …

### å®Œäº†ã—ãŸå†…å®¹

1. **DispatchStrategy + DirectDispatchï¼ˆPR-4ï¼‰** - å®Œå…¨å®Ÿè£…æ¸ˆã¿ âœ…
   - DispatchStrategy traitï¼ˆports/dispatch.rsï¼‰
   - DirectDispatch å®Ÿè£…ï¼ˆimpls/dispatch.rsï¼‰
   - ãƒ†ã‚¹ãƒˆ 1 å€‹ï¼ˆå…¨ã¦æˆåŠŸï¼‰
   - impls ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ•´å‚™
   - typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### æ¬¡å›ã®ä½œæ¥­

1. **PR-5: èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰**

   **å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:**
   - `crates/weaver-core/src/app/builder.rs` - AppBuilder::expect_tasks() ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿½åŠ 
   - `crates/weaver-core/src/app/mod.rs` - builder ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…¬é–‹

   **å®Ÿè£…å†…å®¹:**
   - AppBuilder ã« expect_tasks() ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
   - build() æ™‚ã« TypedRegistry.registered_types() ã§ç™»éŒ²æ¸ˆã¿é›†åˆã‚’å–å¾—
   - æœŸå¾…é›†åˆ âŠ† ç™»éŒ²æ¸ˆã¿é›†åˆ ã‚’ãƒã‚§ãƒƒã‚¯
   - ä¸è¶³ãŒã‚ã‚Œã° panic ã¾ãŸã¯ Result::Err

   **å‚è€ƒè³‡æ–™:**
   - è¦ä»¶ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ 5.3 ç¯€ã€Œèµ·å‹•æ™‚æ¤œè¨¼ã€
   - tasks.md PR-5

2. **ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰çŠ¶æ…‹**
   - typed ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å®Œæˆæ¸ˆã¿ï¼ˆTODO ã‚³ãƒ¡ãƒ³ãƒˆãªã—ï¼‰
   - impls/dispatch.rs ã¯å®Œæˆæ¸ˆã¿
   - cargo check, cargo test ã¨ã‚‚ã«æˆåŠŸ

### æ³¨æ„äº‹é …

- AppBuilder ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€æ–°è¦ä½œæˆãŒå¿…è¦
- app/mod.rs ã‚‚æ•´å‚™ãŒå¿…è¦ï¼ˆbuilder ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…¬é–‹ï¼‰
- PR-5 ã§ã¯ DispatchStrategy ã®çµ±åˆã‚‚æ¤œè¨ï¼ˆAppBuilder ã« strategy ã‚’ä¿æŒï¼‰

### å­¦ç¿’ã®ãƒã‚¤ãƒ³ãƒˆ

PR-5 ã§ã¯ä»¥ä¸‹ã‚’å­¦ã³ã¾ã™ï¼š
- Builder ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…
- æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®çµ„ã¿è¾¼ã¿
- Fail-fast è¨­è¨ˆï¼ˆèµ·å‹•æ™‚ã«å•é¡Œã‚’æ¤œå‡ºï¼‰
- é–‹ç™ºä½“é¨“ã®æ”¹å–„ï¼ˆæ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰

---

## â³ PR-5: èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰ï¼ˆå­¦ç¿’ã‚¿ã‚¹ã‚¯ï¼‰

### ğŸ“‹ ã‚¿ã‚¹ã‚¯ã®æ¦‚è¦
AppBuilder ã« expect_tasks() ã¨ build() ã‚’å®Ÿè£…ã—ã€ç™»éŒ²æ¼ã‚Œã‚’èµ·å‹•æ™‚ã«æ¤œçŸ¥ã™ã‚‹ Fail-fast è¨­è¨ˆã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### ğŸ¯ å­¦ç¿’ç›®æ¨™
ã“ã®ã‚¿ã‚¹ã‚¯ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã® Rust ã®æ¦‚å¿µã‚’å®Ÿè·µçš„ã«å­¦ã³ã¾ã™ï¼š
1. **Builder ãƒ‘ã‚¿ãƒ¼ãƒ³** - ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã«ã‚ˆã‚‹æ®µéšçš„æ§‹ç¯‰
2. **Fail-fast è¨­è¨ˆ** - å•é¡Œã‚’æ—©æœŸã«æ¤œå‡ºã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
3. **é›†åˆæ¼”ç®—** - Vec ã® contains() ã‚’ä½¿ã£ãŸæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯

### ğŸ“ å®Ÿè£…ã™ã¹ãå†…å®¹
**å¤‰æ›´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:** `crates/weaver-core/src/app/builder.rs`

**å®Ÿè£…ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰:**
1. `expect_tasks(mut self, task_types: &[&str]) -> Self`
2. `build(self) -> Result<App, BuildError>`
3. ãƒ†ã‚¹ãƒˆï¼ˆ#[cfg(test)] mod testsï¼‰

### âœ… æ©Ÿèƒ½è¦ä»¶

**1. expect_tasks() ãƒ¡ã‚½ãƒƒãƒ‰**
- å¼•æ•°: `task_types: &[&str]` - æœŸå¾…ã•ã‚Œã‚‹ task_type ã®ã‚¹ãƒ©ã‚¤ã‚¹
- å‹•ä½œ: `expected_tasks` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« `Vec<String>` ã¨ã—ã¦ä¿å­˜
- æˆ»ã‚Šå€¤: `Self`ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³å¯èƒ½ï¼‰

**2. build() ãƒ¡ã‚½ãƒƒãƒ‰**
- `expected_tasks` ãŒ `Some` ã®å ´åˆã®ã¿æ¤œè¨¼
- `registry.registered_types()` ã§ç™»éŒ²æ¸ˆã¿é›†åˆã‚’å–å¾—
- æœŸå¾…é›†åˆã®å„è¦ç´ ãŒç™»éŒ²æ¸ˆã¿é›†åˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
- ä¸è¶³ãŒã‚ã‚Œã° `BuildError::MissingTaskTypes(missing)` ã‚’è¿”ã™
- æ¤œè¨¼æˆåŠŸãªã‚‰ `Ok(App { registry: self.registry })` ã‚’è¿”ã™

**3. ãƒ†ã‚¹ãƒˆ**
- æ­£å¸¸ç³»: å…¨ã¦ã® task_type ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹
- ç•°å¸¸ç³»: ä¸€éƒ¨ã® task_type ãŒæœªç™»éŒ²
- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: expected_tasks ãŒ Noneï¼ˆæ¤œè¨¼ã‚¹ã‚­ãƒƒãƒ—ï¼‰

### ğŸš¨ æŠ€è¡“çš„åˆ¶ç´„ï¼ˆéå¸¸ã«é‡è¦ï¼‰

1. **expected_tasks ã¯ Option<Vec<String>>**
   - None ã®å ´åˆã¯æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
   - Some ã®å ´åˆã®ã¿æ¤œè¨¼ã‚’å®Ÿè¡Œ

2. **é›†åˆæ¼”ç®—ã®å®Ÿè£…**
   - `Vec::contains()` ã‚’ä½¿ã£ã¦ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
   - ä¸è¶³åˆ†ã‚’ `Vec<String>` ã¨ã—ã¦é›†ã‚ã‚‹

3. **æ‰€æœ‰æ¨©ã®æ‰±ã„**
   - `expect_tasks()` ã¯ `self` ã‚’å—ã‘å–ã‚Šã€`Self` ã‚’è¿”ã™ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ï¼‰
   - `build()` ã¯ `self` ã‚’ consume ã—ã¦ `App` ã‚’è¿”ã™

### ğŸ’¡ æ®µéšçš„ãƒ’ãƒ³ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦é–‹ãï¼‰

<details>
<summary>L1: æ–¹å‘æ€§ã®ã¿ï¼ˆã¾ãšã¯ã“ã“ã‹ã‚‰ï¼‰</summary>

**expect_tasks() ã®å®Ÿè£…:**
- ã‚¹ãƒ©ã‚¤ã‚¹ `&[&str]` ã‚’ `Vec<String>` ã«å¤‰æ›ï¼ˆiter().map().collect()ï¼‰
- `expected_tasks` ã« `Some(vec)` ã¨ã—ã¦ä¿å­˜
- `self` ã‚’è¿”ã™ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ï¼‰

**build() ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯:**
- `if let Some(expected) = self.expected_tasks` ã§åˆ†å²
- `registry.registered_types()` ã§ç™»éŒ²æ¸ˆã¿é›†åˆã‚’å–å¾—
- `expected` ã®å„è¦ç´ ã«ã¤ã„ã¦ `registered.contains()` ã§ãƒã‚§ãƒƒã‚¯
- ä¸è¶³åˆ†ã‚’é›†ã‚ã¦ã€ã‚ã‚Œã° `Err(BuildError::MissingTaskTypes(...))`

**ãƒ†ã‚¹ãƒˆ:**
- TestTask, AnotherTestTask ã‚’ä½¿ã£ã¦ç™»éŒ²
- expect_tasks(&["test.task.v1"]) ã§æœŸå¾…å€¤ã‚’è¨­å®š
- build() ã®æˆåŠŸ/å¤±æ•—ã‚’ãƒ†ã‚¹ãƒˆ

</details>

<details>
<summary>L2: æ¤œè¨ã™ã¹ãå ´æ‰€ï¼ˆL1ã§è©°ã¾ã£ãŸã‚‰é–‹ãï¼‰</summary>

**expect_tasks() ã®å¤‰æ›:**
```rust
// &[&str] â†’ Vec<String> ã¸ã®å¤‰æ›
task_types.iter().map(|s| s.to_string()).collect()
```

**build() ã®æ¤œè¨¼:**
```rust
// ç™»éŒ²æ¸ˆã¿é›†åˆã®å–å¾—
let registered = self.registry.registered_types();

// ä¸è¶³åˆ†ã‚’é›†ã‚ã‚‹
let missing: Vec<String> = expected
    .iter()
    .filter(|task_type| !registered.contains(task_type))
    .cloned()
    .collect();

// ä¸è¶³ãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼
if !missing.is_empty() {
    return Err(BuildError::MissingTaskTypes(missing));
}
```

**ãƒ†ã‚¹ãƒˆã®æ§‹æˆ:**
- TestTaskHandler, AnotherTestTaskHandler ã‚’ä½¿ç”¨
- AppBuilder::new().register().expect_tasks().build() ã®ãƒã‚§ãƒ¼ãƒ³

</details>

<details>
<summary>L3: æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼ˆè¨­è¨ˆã®æ–¹å‘ãŒä¸æ˜ãªå ´åˆï¼‰</summary>

**expect_tasks():**
```
fn expect_tasks(mut self, task_types: &[&str]) -> Self {
    ã‚¹ãƒ©ã‚¤ã‚¹ã‚’ Vec<String> ã«å¤‰æ›
    self.expected_tasks = Some(å¤‰æ›ã—ãŸ vec)
    self ã‚’è¿”ã™
}
```

**build():**
```
fn build(self) -> Result<App, BuildError> {
    if expected_tasks ãŒ Some ãªã‚‰:
        ç™»éŒ²æ¸ˆã¿é›†åˆ = registry.registered_types()
        ä¸è¶³åˆ† = expected ã®è¦ç´ ã§ registered ã«å«ã¾ã‚Œãªã„ã‚‚ã®
        if ä¸è¶³åˆ†ãŒç©ºã§ãªã„:
            Err(BuildError::MissingTaskTypes(ä¸è¶³åˆ†))
        else:
            Ok(App { registry })
    else:
        æ¤œè¨¼ã‚¹ã‚­ãƒƒãƒ—
        Ok(App { registry })
}
```

**ãƒ†ã‚¹ãƒˆ:**
```
#[test]
fn test_expect_tasks_success() {
    AppBuilder::new()
        .register::<TestTask>(handler)
        .expect_tasks(&[TestTask::TYPE])
        .build()
        .unwrap(); // æˆåŠŸ
}

#[test]
fn test_expect_tasks_missing() {
    let result = AppBuilder::new()
        .register::<TestTask>(handler)
        .expect_tasks(&["missing.task"])
        .build();
    assert!(matches!(result, Err(BuildError::MissingTaskTypes(_))));
}
```

</details>

<details>
<summary>L4: éƒ¨åˆ†çš„ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰</summary>

```rust
pub fn expect_tasks(mut self, task_types: &[&str]) -> Self {
    self.expected_tasks = Some(
        task_types.iter().map(|s| s.to_string()).collect()
    );
    self
}

pub fn build(self) -> Result<App, BuildError> {
    if let Some(expected) = self.expected_tasks {
        let registered = self.registry.registered_types();
        // TODO(human): ä¸è¶³åˆ†ã‚’é›†ã‚ã¦ã€ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
    }
    // TODO(human): æ¤œè¨¼æˆåŠŸæ™‚ã®å‡¦ç†
}
```

**æ³¨æ„:** ã“ã‚Œã¯æ§‹é€ ã®ã¿ã€‚æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ†ã‚¹ãƒˆã¯è‡ªåˆ†ã§è€ƒãˆã¦ãã ã•ã„ã€‚

</details>

### ğŸ” å®Ÿè£…å¾Œã®ç¢ºèªäº‹é …

- [ ] cargo check ãŒæˆåŠŸã™ã‚‹
- [ ] cargo test --lib app::builder ãŒæˆåŠŸã™ã‚‹
- [ ] builder.rs ã® TODO(human) ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
- [ ] 3ã¤ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ï¼ˆæ­£å¸¸ç³»ã€ç•°å¸¸ç³»ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼‰

---

### PR-5 å®Ÿè£…å®Œäº†

#### å®Ÿè£…å†…å®¹
- AppBuilder::expect_tasks() ãƒ¡ã‚½ãƒƒãƒ‰
- AppBuilder::build() ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
- ãƒ†ã‚¹ãƒˆ 3 å€‹ï¼ˆå…¨ã¦æˆåŠŸï¼‰

#### ãƒ†ã‚¹ãƒˆçµæœ
```
test app::builder::tests::test_build_success ... ok
test app::builder::tests::test_build_missing_task_types ... ok
test app::builder::tests::test_build_no_expect_tasks ... ok

test result: ok. 3 passed; 0 failed; 0 ignored
```

#### å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ

**1. for ãƒ«ãƒ¼ãƒ— vs iter().map().collect()**
expect_tasks() ã§ã¯ for ãƒ«ãƒ¼ãƒ—ã§å®Ÿè£…ï¼š
```rust
let mut expected_tasks = Vec::new();
for &task_type in task_types {
    expected_tasks.push(task_type.to_string());
}
```

ã‚¤ãƒ‡ã‚£ã‚ªãƒ çš„ã«ã¯ iter().map() ã‚‚ä½¿ãˆã‚‹ãŒã€for ãƒ«ãƒ¼ãƒ—ã‚‚å®Œå…¨ã«æ­£ã—ã„å®Ÿè£…ã€‚

**2. filter() ã«ã‚ˆã‚‹é›†åˆæ¼”ç®—**
build() ã§ã¯ä¸è¶³åˆ†ã‚’ filter() ã§é›†ã‚ã‚‹ï¼š
```rust
let missing_tasks: Vec<String> = expected_tasks
    .iter()
    .filter(|x| !registered_types.contains(x))
    .cloned()
    .collect();
```

- `filter()`: æ¡ä»¶ã«åˆã†ã‚‚ã®ã ã‘ã‚’é€šã™
- `cloned()`: &String â†’ String ã«å¤‰æ›
- `collect()`: Iterator â†’ Vec ã«å¤‰æ›

**3. Turbofish æ§‹æ–‡ã®è£œè¶³**
æœ€åˆ `.collect::<Vec<String>>()` ã¨æ›¸ã„ãŸãŒã€å‹æ³¨é‡ˆãŒã‚ã‚‹ã®ã§ä¸è¦ï¼š
```rust
let missing_tasks: Vec<String> = ... .collect();  // âœ… å‹æ¨è«–ãŒåŠ¹ã
```

**4. matches! ãƒã‚¯ãƒ­ã«ã‚ˆã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ**
ãƒ†ã‚¹ãƒˆã§ã¯ matches! ãƒã‚¯ãƒ­ã‚’ä½¿ã£ã¦é«˜åº¦ãªæ¤œè¨¼ï¼š
```rust
assert!(matches!(
    app,
    Err(BuildError::MissingTaskTypes(missing)) if missing == vec![AnotherTestTask::TYPE.to_string()]
));
```

- ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã¨ã‚¬ãƒ¼ãƒ‰æ¡ä»¶ã‚’çµ„ã¿åˆã‚ã›ã¦ã€ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã¾ã§æ¤œè¨¼ã§ãã‚‹

---

## ğŸ“ˆ Week 1 ã®é€²æ—ï¼ˆæ›´æ–°ï¼‰

- âœ… PR-1: Module Tree ç§»è¡Œï¼ˆ2026-01-04 å®Œäº†ï¼‰
- âœ… PR-2: ULID Newtypes + IdGenerator/Clockï¼ˆ2026-01-04 å®Œäº†ï¼‰
- âœ… PR-3: Typed Task APIï¼ˆ2026-01-07 å®Œäº†ï¼‰
- âœ… PR-4: DispatchStrategyï¼ˆtraitï¼‰+ DirectDispatchï¼ˆ2026-01-11 å®Œäº†ï¼‰
- âœ… **PR-5: èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰ï¼ˆ2026-01-11 å®Œäº†ï¼‰** â† ä»Šæ—¥å®Œæˆï¼
- â³ PR-6: InMemoryDeliveryQueueï¼ˆé–‹ç™ºç”¨ï¼‰â† æ¬¡ã¯ã“ã‚Œ

**é€²æ—ç‡:** 5/6 (83%)

## ğŸ‰ ä»Šæ—¥ã®æˆæœã¾ã¨ã‚

### å®Œäº†ã—ãŸ PR

1. **PR-4: DispatchStrategy + DirectDispatch**
   - Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…
   - Object-safe ãª trait è¨­è¨ˆ
   - Zero-sized type ã®æ´»ç”¨

2. **PR-5: èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰**
   - Builder ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…
   - Fail-fast è¨­è¨ˆ
   - filter() ã«ã‚ˆã‚‹é›†åˆæ¼”ç®—
   - matches! ãƒã‚¯ãƒ­ã«ã‚ˆã‚‹é«˜åº¦ãªãƒ†ã‚¹ãƒˆ

### å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

- `crates/weaver-core/src/ports/dispatch.rs` - DispatchStrategy trait
- `crates/weaver-core/src/impls/dispatch.rs` - DirectDispatch å®Ÿè£…
- `crates/weaver-core/src/app/builder.rs` - AppBuilder å®Ÿè£…

### ãƒ†ã‚¹ãƒˆçµæœ

- DirectDispatch: 1 test passed
- AppBuilder: 3 tests passed
- **åˆè¨ˆ: 4 tests passed**

## ğŸ’­ æ‰€æ„Ÿï¼ˆä»Šæ—¥ã®å­¦ã³ï¼‰

### PR-4 ã§å­¦ã‚“ã ã“ã¨

1. **Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…**: trait ã«ã‚ˆã‚‹æŒ¯ã‚‹èˆã„ã®å·®ã—æ›¿ãˆ
2. **Object safety**: trait object ã¨ã—ã¦ä½¿ãˆã‚‹ãŸã‚ã®åˆ¶ç´„
3. **Zero-sized type**: ãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆ 0 ã® struct

### PR-5 ã§å­¦ã‚“ã ã“ã¨

1. **Builder ãƒ‘ã‚¿ãƒ¼ãƒ³**: ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã«ã‚ˆã‚‹æ®µéšçš„æ§‹ç¯‰
2. **Fail-fast è¨­è¨ˆ**: èµ·å‹•æ™‚ã«å•é¡Œã‚’æ¤œå‡ºã—ã¦æ—©æœŸã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
3. **é›†åˆæ¼”ç®—**: filter() ã¨ contains() ã«ã‚ˆã‚‹æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
4. **Turbofish æ§‹æ–‡**: å‹æ¨è«–ãŒã‚ã‚Œã°ä¸è¦

### ä»Šå¾Œã®å­¦ç¿’

æ¬¡ã¯ PR-6ï¼ˆInMemoryDeliveryQueueï¼‰ã§ã€Week 1 ã‚’å®Œäº†ã•ã›ã¾ã™ã€‚DeliveryQueue trait ã®å®Ÿè£…ã‚’é€šã˜ã¦ã€éåŒæœŸ trait ã¨ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°æ“ä½œã‚’å­¦ã³ã¾ã™ã€‚

Week 1 ãŒã‚ã¨ 1 PR ã§å®Œäº†ã—ã¾ã™ï¼

---

## â³ PR-6: InMemoryDeliveryQueueï¼ˆå­¦ç¿’ã‚¿ã‚¹ã‚¯ï¼‰

### ğŸ“‹ ã‚¿ã‚¹ã‚¯ã®æ¦‚è¦
InMemoryDeliveryQueue ã® pop() ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã€Mutex + Condvar ã«ã‚ˆã‚‹ blocking pop ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### ğŸ¯ å­¦ç¿’ç›®æ¨™
ã“ã®ã‚¿ã‚¹ã‚¯ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã® Rust ã®æ¦‚å¿µã‚’å®Ÿè·µçš„ã«å­¦ã³ã¾ã™ï¼š
1. **Mutex + Condvar** - ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã®åŒæœŸã¨å¾…æ©Ÿ
2. **spawn_blocking** - Async context ã§ã®åŒæœŸå‡¦ç†
3. **Spurious wakeup** - Condvar ã®æ³¨æ„ç‚¹ã¨å¯¾ç­–

### ğŸ“ å®Ÿè£…ã™ã¹ãå†…å®¹
**å¤‰æ›´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:** `crates/weaver-core/src/impls/inmem_delivery.rs`

**å®Ÿè£…ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰:**
1. `pop(&self, ns: &str, timeout: Duration) -> Result<Option<TaskId>, QueueError>`
2. ãƒ†ã‚¹ãƒˆï¼ˆ#[cfg(test)] mod testsï¼‰

### âœ… æ©Ÿèƒ½è¦ä»¶

**1. pop() ãƒ¡ã‚½ãƒƒãƒ‰**
- namespace ã®ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ task_id ã‚’ pop_front
- ã‚­ãƒ¥ãƒ¼ãŒç©ºãªã‚‰ timeout ã¾ã§ waitï¼ˆCondvar ã‚’ä½¿ç”¨ï¼‰
- timeout çµŒéã—ãŸã‚‰ None ã‚’è¿”ã™
- spawn_blocking ã§åŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œ

**2. ãƒ†ã‚¹ãƒˆ**
- push/pop ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—
- pop ãŒç©ºã‚­ãƒ¥ãƒ¼ã§ timeout ã™ã‚‹ã“ã¨
- è¤‡æ•°ã® namespace ãŒç‹¬ç«‹ã—ã¦å‹•ä½œã™ã‚‹ã“ã¨
- push ãŒ pop ã‚’èµ·ã“ã™ã“ã¨ï¼ˆblocking ã®è§£é™¤ï¼‰

### ğŸš¨ æŠ€è¡“çš„åˆ¶ç´„ï¼ˆéå¸¸ã«é‡è¦ï¼‰

1. **Condvar::wait_timeout() ã®ä½¿ã„æ–¹**
   - `wait_timeout()` ã¯ (MutexGuard, WaitTimeoutResult) ã‚’è¿”ã™
   - WaitTimeoutResult::timed_out() ã§ timeout ã‚’ç¢ºèª

2. **Spurious wakeup å¯¾ç­–**
   - Condvar ã¯ç†ç”±ãªãèµ·ãã‚‹ã“ã¨ãŒã‚ã‚‹ï¼ˆspurious wakeupï¼‰
   - ãƒ«ãƒ¼ãƒ—ã§ã€Œã‚­ãƒ¥ãƒ¼ã«è¦ç´ ãŒã‚ã‚‹ã‹ã€ã‚’ç¢ºèª

3. **æ®‹ã‚Šæ™‚é–“ã®è¨ˆç®—**
   - Instant::now() ã§é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
   - elapsed() ã§çµŒéæ™‚é–“ã‚’è¨ˆç®—
   - æ®‹ã‚Šæ™‚é–“ = timeout - elapsed

### ğŸ’¡ æ®µéšçš„ãƒ’ãƒ³ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦é–‹ãï¼‰

<details>
<summary>L1: æ–¹å‘æ€§ã®ã¿ï¼ˆã¾ãšã¯ã“ã“ã‹ã‚‰ï¼‰</summary>

**å…¨ä½“ã®æµã‚Œ:**
1. spawn_blocking ã§ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’å®Ÿè¡Œ
2. ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£å†…ã§ Mutex ã‚’ãƒ­ãƒƒã‚¯
3. ãƒ«ãƒ¼ãƒ—ã§ã€Œã‚­ãƒ¥ãƒ¼ã«è¦ç´ ãŒã‚ã‚‹ã‹ OR timeoutã€ã¾ã§å¾…æ©Ÿ
4. è¦ç´ ãŒã‚ã‚Œã° pop_frontã€ãªã‘ã‚Œã° None

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ:**
- wait_timeout() ã¯ Mutex ã‚’ä¸€æ™‚çš„ã«è§£æ”¾ã—ã¦å¾…æ©Ÿ
- notify_one() ã§èµ·ã“ã•ã‚ŒãŸã‚‰å†åº¦ãƒ«ãƒ¼ãƒ—ã§ç¢ºèª
- timeout ã®æ®‹ã‚Šæ™‚é–“ã‚’æ¯å›è¨ˆç®—

</details>

<details>
<summary>L2: æ¤œè¨ã™ã¹ãå ´æ‰€ï¼ˆL1ã§è©°ã¾ã£ãŸã‚‰é–‹ãï¼‰</summary>

**Condvar::wait_timeout() ã®ä½¿ã„æ–¹:**
```rust
use std::time::Instant;

let start = Instant::now();
let deadline = timeout;

loop {
    let elapsed = start.elapsed();
    if elapsed >= deadline {
        return Ok(None); // timeout
    }
    
    let remaining = deadline - elapsed;
    let (guard, result) = condvar.wait_timeout(guard, remaining).unwrap();
    
    if result.timed_out() {
        return Ok(None);
    }
    
    // ã‚­ãƒ¥ãƒ¼ã«è¦ç´ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if let Some(queue) = guard.get_mut(&ns) {
        if let Some(task_id) = queue.pop_front() {
            return Ok(Some(task_id));
        }
    }
}
```

**spawn_blocking ã®æ§‹é€ :**
```rust
tokio::task::spawn_blocking(move || {
    // åŒæœŸå‡¦ç†
    let mut guard = queues.lock().unwrap();
    // ... ãƒ«ãƒ¼ãƒ—ã§ wait_timeout
})
.await
.map_err(...)
```

</details>

<details>
<summary>L3: æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ï¼ˆè¨­è¨ˆã®æ–¹å‘ãŒä¸æ˜ãªå ´åˆï¼‰</summary>

```
async fn pop(ns, timeout) {
    spawn_blocking ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
        é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ² (Instant::now())
        Mutex ã‚’ãƒ­ãƒƒã‚¯ â†’ guard
        
        loop {
            çµŒéæ™‚é–“ã‚’è¨ˆç®—
            if çµŒéæ™‚é–“ >= timeout:
                return None
            
            æ®‹ã‚Šæ™‚é–“ = timeout - çµŒéæ™‚é–“
            
            // namespace ã®ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
            if ã‚­ãƒ¥ãƒ¼ã«è¦ç´ ãŒã‚ã‚‹:
                pop_front ã—ã¦ return Some(task_id)
            
            // è¦ç´ ãŒãªã„ã®ã§ wait
            (guard, result) = condvar.wait_timeout(guard, æ®‹ã‚Šæ™‚é–“)
            
            if result.timed_out():
                return None
        }
}
```

</details>

<details>
<summary>L4: éƒ¨åˆ†çš„ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰</summary>

```rust
async fn pop(&self, ns: &str, timeout: Duration) -> Result<Option<TaskId>, QueueError> {
    let queues = self.queues.clone();
    let condvar = self.condvar.clone();
    let ns = ns.to_string();

    tokio::task::spawn_blocking(move || {
        let start = std::time::Instant::now();
        let mut guard = queues.lock().unwrap();

        loop {
            let elapsed = start.elapsed();
            if elapsed >= timeout {
                return Ok(None);
            }

            // TODO(human): ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
            // if let Some(queue) = guard.get_mut(&ns) { ... }

            // TODO(human): wait_timeout ã§å¾…æ©Ÿ
            // let remaining = timeout - elapsed;
            // let (new_guard, result) = condvar.wait_timeout(guard, remaining).unwrap();
        }
    })
    .await
    .map_err(|e| QueueError::OperationFailed(format!("Pop failed: {}", e)))?
}
```

**æ³¨æ„:** ã“ã‚Œã¯æ§‹é€ ã®ã¿ã€‚ãƒ«ãƒ¼ãƒ—å†…ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ†ã‚¹ãƒˆã¯è‡ªåˆ†ã§è€ƒãˆã¦ãã ã•ã„ã€‚

</details>

### ğŸ” å®Ÿè£…å¾Œã®ç¢ºèªäº‹é …

- [ ] cargo check ãŒæˆåŠŸã™ã‚‹
- [ ] cargo test --lib impls::inmem_delivery ãŒæˆåŠŸã™ã‚‹
- [ ] inmem_delivery.rs ã® TODO(human) ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
- [ ] 4ã¤ã®ãƒ†ã‚¹ãƒˆãŒé€šã‚‹

---

### PR-6 å®Ÿè£…å®Œäº†

#### å®Ÿè£…å†…å®¹
- DeliveryQueue trait ã®å®šç¾©
- InMemoryDeliveryQueue ã®å®Ÿè£…
  - push() ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆspawn_blocking + notify_oneï¼‰
  - pop() ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆCondvar::wait_timeout + spurious wakeup å¯¾ç­–ï¼‰
- ãƒ†ã‚¹ãƒˆ 4 å€‹ï¼ˆå…¨ã¦æˆåŠŸï¼‰

#### ãƒ†ã‚¹ãƒˆçµæœ
```
test impls::inmem_delivery::tests::test_push_pop_roundtrip ... ok
test impls::inmem_delivery::tests::test_multiple_namespaces ... ok
test impls::inmem_delivery::tests::test_pop_timeout ... ok
test impls::inmem_delivery::tests::test_push_wakes_pop ... ok

test result: ok. 4 passed; 0 failed; 0 ignored
```

#### å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ

**1. Condvar::wait_timeout() ã®ä½¿ã„æ–¹**
pop() ã§ã¯ Condvar ã‚’ä½¿ã£ã¦ blocking wait ã‚’å®Ÿè£…ï¼š
```rust
let (new_guard, result) = condvar.wait_timeout(guard, remaining).unwrap();
guard = new_guard;  // guard ã‚’æ›´æ–°

if result.timed_out() {
    return Ok(None);
}
```

**é‡è¦:** `wait_timeout()` ã¯æ–°ã—ã„ `MutexGuard` ã‚’è¿”ã™ã®ã§ã€ãã‚Œã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**2. Spurious wakeup å¯¾ç­–**
Condvar ã¯ç†ç”±ãªãèµ·ãã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€ãƒ«ãƒ¼ãƒ—ã§æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯ï¼š
```rust
loop {
    // ã‚­ãƒ¥ãƒ¼ã«è¦ç´ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if let Some(queue) = guard.get_mut(&ns)
        && let Some(task_id) = queue.pop_front()
    {
        return Ok(Some(task_id));
    }
    
    // è¦ç´ ãŒãªã‘ã‚Œã° wait
    let (new_guard, result) = condvar.wait_timeout(guard, remaining).unwrap();
    guard = new_guard;
}
```

**3. timeout ã®æ®‹ã‚Šæ™‚é–“è¨ˆç®—**
timeout ã¯ç·æ™‚é–“ãªã®ã§ã€æ¯å›æ®‹ã‚Šæ™‚é–“ã‚’è¨ˆç®—ï¼š
```rust
let start = Instant::now();

loop {
    let elapsed = start.elapsed();
    if elapsed >= timeout {
        return Ok(None);
    }
    
    let remaining = timeout.saturating_sub(elapsed);
    // ...
}
```

**4. Let ãƒã‚§ãƒ¼ãƒ³æ§‹æ–‡ï¼ˆRust 1.65+ï¼‰**
è¤‡æ•°ã® `if let` ã‚’ãƒ•ãƒ©ãƒƒãƒˆã«æ›¸ã‘ã‚‹ï¼š
```rust
// Before (ãƒã‚¹ãƒˆ)
if let Some(queue) = guard.get_mut(&ns) {
    if let Some(task_id) = queue.pop_front() {
        return Ok(Some(task_id));
    }
}

// After (let ãƒã‚§ãƒ¼ãƒ³)
if let Some(queue) = guard.get_mut(&ns)
    && let Some(task_id) = queue.pop_front()
{
    return Ok(Some(task_id));
}
```

**5. ä¸¦è¡Œãƒ†ã‚¹ãƒˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³**
test_push_wakes_pop ã§ã¯ã€push ãŒ blocking pop ã‚’èµ·ã“ã™ã“ã¨ã‚’ç¢ºèªï¼š
```rust
let queue = Arc::new(InMemoryDeliveryQueue::new());

// åˆ¥ã‚¿ã‚¹ã‚¯ã§ blocking pop ã‚’é–‹å§‹
let pop_future = tokio::spawn({
    let queue = queue.clone();
    async move { queue.pop("default", Duration::from_secs(5)).await.unwrap() }
});

// å°‘ã—å¾…ã£ã¦ã‹ã‚‰ push
tokio::time::sleep(Duration::from_millis(500)).await;
queue.push("default", task_id).await.unwrap();

// pop ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
let popped = pop_future.await.unwrap();
```

ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ Worker ã®å‹•ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ãŠã‚Šã€å®Ÿéš›ã®ä¸¦è¡Œå‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚

---

## ğŸ‰ Week 1 å®Œäº†ï¼

- âœ… PR-1: Module Tree ç§»è¡Œï¼ˆ2026-01-04 å®Œäº†ï¼‰
- âœ… PR-2: ULID Newtypes + IdGenerator/Clockï¼ˆ2026-01-04 å®Œäº†ï¼‰
- âœ… PR-3: Typed Task APIï¼ˆ2026-01-07 å®Œäº†ï¼‰
- âœ… PR-4: DispatchStrategyï¼ˆtraitï¼‰+ DirectDispatchï¼ˆ2026-01-11 å®Œäº†ï¼‰
- âœ… PR-5: èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰ï¼ˆ2026-01-11 å®Œäº†ï¼‰
- âœ… **PR-6: InMemoryDeliveryQueueï¼ˆé–‹ç™ºç”¨ï¼‰ï¼ˆ2026-01-11 å®Œäº†ï¼‰** â† ä»Šæ—¥å®Œæˆï¼

**é€²æ—ç‡:** 6/6 (100%) ğŸ‰

## ğŸ‰ ä»Šæ—¥ã®æˆæœã¾ã¨ã‚ï¼ˆæœ€çµ‚ç‰ˆï¼‰

### å®Œäº†ã—ãŸ PR

1. **PR-4: DispatchStrategy + DirectDispatch**
   - Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…
   - Object-safe ãª trait è¨­è¨ˆ
   - Zero-sized type ã®æ´»ç”¨
   - ãƒ†ã‚¹ãƒˆ 1 å€‹ï¼ˆæˆåŠŸï¼‰

2. **PR-5: èµ·å‹•æ™‚æ¤œè¨¼ï¼ˆexpect_tasksï¼‰**
   - Builder ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…
   - Fail-fast è¨­è¨ˆ
   - filter() ã«ã‚ˆã‚‹é›†åˆæ¼”ç®—
   - matches! ãƒã‚¯ãƒ­ã«ã‚ˆã‚‹é«˜åº¦ãªãƒ†ã‚¹ãƒˆ
   - ãƒ†ã‚¹ãƒˆ 3 å€‹ï¼ˆå…¨ã¦æˆåŠŸï¼‰

3. **PR-6: InMemoryDeliveryQueueï¼ˆé–‹ç™ºç”¨ï¼‰**
   - DeliveryQueue trait ã®å®šç¾©
   - Mutex + Condvar ã«ã‚ˆã‚‹ blocking pop
   - spawn_blocking ã§ã®åŒæœŸå‡¦ç†
   - Spurious wakeup å¯¾ç­–
   - Let ãƒã‚§ãƒ¼ãƒ³æ§‹æ–‡
   - ä¸¦è¡Œãƒ†ã‚¹ãƒˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³
   - ãƒ†ã‚¹ãƒˆ 4 å€‹ï¼ˆå…¨ã¦æˆåŠŸï¼‰

### å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

- `crates/weaver-core/src/ports/dispatch.rs` - DispatchStrategy trait
- `crates/weaver-core/src/impls/dispatch.rs` - DirectDispatch å®Ÿè£…
- `crates/weaver-core/src/app/builder.rs` - AppBuilder å®Ÿè£…
- `crates/weaver-core/src/ports/delivery_queue.rs` - DeliveryQueue trait
- `crates/weaver-core/src/impls/inmem_delivery.rs` - InMemoryDeliveryQueue å®Ÿè£…

### ãƒ†ã‚¹ãƒˆçµæœ

- DirectDispatch: 1 test passed
- AppBuilder: 3 tests passed
- InMemoryDeliveryQueue: 4 tests passed
- **åˆè¨ˆ: 8 tests passed** ğŸ‰

### ã‚³ãƒ¼ãƒ‰çµ±è¨ˆ

- æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: 4 å€‹
- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«: 15+ å€‹
- è¿½åŠ è¡Œæ•°: 600+ è¡Œ
- ãƒ†ã‚¹ãƒˆ: 8 å€‹ï¼ˆå…¨ã¦æˆåŠŸï¼‰

## ğŸ’­ æ‰€æ„Ÿï¼ˆWeek 1 å®Œäº†ã®æŒ¯ã‚Šè¿”ã‚Šï¼‰

### ä»Šæ—¥ï¼ˆ2026-01-11ï¼‰ã®å­¦ã³

**PR-4 ã§å­¦ã‚“ã ã“ã¨:**
1. **Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³**: trait ã«ã‚ˆã‚‹æŒ¯ã‚‹èˆã„ã®å·®ã—æ›¿ãˆ
2. **Object safety**: trait object ã¨ã—ã¦ä½¿ãˆã‚‹ãŸã‚ã®åˆ¶ç´„
3. **Zero-sized type**: ãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆ 0 ã® struct

**PR-5 ã§å­¦ã‚“ã ã“ã¨:**
1. **Builder ãƒ‘ã‚¿ãƒ¼ãƒ³**: ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã«ã‚ˆã‚‹æ®µéšçš„æ§‹ç¯‰
2. **Fail-fast è¨­è¨ˆ**: èµ·å‹•æ™‚ã«å•é¡Œã‚’æ¤œå‡ºã—ã¦æ—©æœŸã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
3. **é›†åˆæ¼”ç®—**: filter() ã¨ contains() ã«ã‚ˆã‚‹æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
4. **Turbofish æ§‹æ–‡**: å‹æ¨è«–ãŒã‚ã‚Œã°ä¸è¦

**PR-6 ã§å­¦ã‚“ã ã“ã¨:**
1. **Mutex + Condvar**: ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã®åŒæœŸã¨å¾…æ©Ÿ
2. **spawn_blocking**: Async context ã§ã®åŒæœŸå‡¦ç†
3. **Spurious wakeup**: Condvar ã®æ³¨æ„ç‚¹ã¨å¯¾ç­–ï¼ˆãƒ«ãƒ¼ãƒ—ã§ãƒã‚§ãƒƒã‚¯ï¼‰
4. **Let ãƒã‚§ãƒ¼ãƒ³æ§‹æ–‡**: Rust 1.65+ ã®æ–°æ©Ÿèƒ½
5. **ä¸¦è¡Œãƒ†ã‚¹ãƒˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³**: tokio::spawn ã‚’ä½¿ã£ãŸ Worker ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### Week 1 å…¨ä½“ã®å­¦ã³

Week 1 ã§ã¯ **éª¨æ ¼ã¨ Typed APIï¼ˆæ­£ã—ã•ã®åœŸå°ï¼‰** ã‚’å®Ÿè£…ã—ã¾ã—ãŸï¼š

1. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ**: Hexagonal Architecture ã®å®Ÿè·µ
2. **å‹å®‰å…¨æ€§**: Typed Task API ã«ã‚ˆã‚‹ task_type typo ã®æ’é™¤
3. **æŠ½è±¡åŒ–**: Trait ã«ã‚ˆã‚‹å®Ÿè£…ã®å·®ã—æ›¿ãˆï¼ˆStrategy, DeliveryQueueï¼‰
4. **æ¤œè¨¼**: èµ·å‹•æ™‚æ¤œè¨¼ã«ã‚ˆã‚‹ Fail-fast è¨­è¨ˆ
5. **ä¸¦è¡Œå‡¦ç†**: Mutex/Condvar ã«ã‚ˆã‚‹ blocking wait ã®å®Ÿè£…

ã“ã‚Œã‚‰ã®åŸºç¤ãŒã‚ã‚‹ã“ã¨ã§ã€Week 2 ã§ã¯ PostgreSQL ã‚„ Redis ãªã©ã®å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã‚’å®‰å…¨ã«çµ±åˆã§ãã¾ã™ã€‚

### æ¬¡é€±ã¸ã®æœŸå¾…

Week 2 ã§ã¯ **PGæ­£æœ¬ + outbox + Redisé…é€ + Blob/TTL + repair** ã‚’å®Ÿè£…ã—ã¾ã™ï¼š

- PostgreSQL ã‚’ source of truth ã¨ã—ã¦ä½¿ç”¨
- Outbox pattern ã«ã‚ˆã‚‹ transactional consistency
- Redis ã§ã®é…é€ã‚­ãƒ¥ãƒ¼
- æœ¬ç•ªç’°å¢ƒã§ä½¿ãˆã‚‹æ°¸ç¶šåŒ–ãƒ»é…é€ãƒ»å¾©æ—§æ©Ÿèƒ½

Week 1 ã§å­¦ã‚“ã æŠ½è±¡åŒ–ã®åŠ›ãŒã€Week 2 ã§æ´»ãã¦ãã¾ã™ï¼

---

## ğŸ“ˆ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**Week 2 ã‚¹ã‚¿ãƒ¼ãƒˆ:**
- PR-7: Postgres TaskStore + migrations
- PR-8: ArtifactStore trait (MinIO/S3/Local)
- PR-9: Outbox pattern
- ...

Week 1 ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ‰

---

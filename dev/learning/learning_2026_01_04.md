# Weaver v2 å­¦ç¿’è¨˜éŒ² - 2026-01-04

## ğŸ“… ä»Šæ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³

**é–‹å§‹æ—¥æ™‚:** 2026-01-04
**ãƒ•ã‚§ãƒ¼ã‚º:** Week 1 - éª¨æ ¼ã¨ Typed APIï¼ˆæ­£ã—ã•ã®åœŸå°ï¼‰
**ã‚¿ã‚¹ã‚¯:** PR-1: Module Tree ç§»è¡Œ

---

## ğŸ¯ ä»Šæ—¥ã®ç›®æ¨™

- [x] v1 â†’ v2 ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã®é•ã„ã‚’ç†è§£ã™ã‚‹
- [x] æ–°ã—ã„ module tree ã‚’å®Ÿè£…ã™ã‚‹
- [x] ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ï¼ˆ`cargo check`ï¼‰
- [x] PR-1: Module Tree ç§»è¡Œï¼ˆå®Œäº†ï¼‰
- [x] PR-2: ULID Newtypes + IdGenerator/Clockï¼ˆå®Œäº†ï¼‰

---

## â³ PR-1: Module Tree ç§»è¡Œï¼ˆå­¦ç¿’ã‚¿ã‚¹ã‚¯ï¼‰

### ğŸ“‹ ã‚¿ã‚¹ã‚¯ã®æ¦‚è¦

v2 ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«åˆã‚ã›ã¦ã€weaver-core ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã‚’å†ç·¨æˆã—ã¾ã™ã€‚
v1 ã®ã€ŒQueueä¸­å¿ƒã€ã‹ã‚‰ v2 ã®ã€ŒStoreä¸­å¿ƒ + Ports & Adaptersã€ã¸ã®ç§»è¡ŒãŒç›®çš„ã§ã™ã€‚

### ğŸ¯ å­¦ç¿’ç›®æ¨™

ã“ã®ã‚¿ã‚¹ã‚¯ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã® Rust ã®æ¦‚å¿µã‚’å®Ÿè·µçš„ã«å­¦ã³ã¾ã™ï¼š

1. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ** - `pub mod`, `pub use` ã«ã‚ˆã‚‹å…¬é–‹ API ã®åˆ¶å¾¡
2. **è²¬å‹™ã®åˆ†é›¢** - domain / ports / app / typed ã®å½¹å‰²åˆ†æ‹…
3. **Hexagonal Architecture** - ãƒãƒ¼ãƒˆ&ã‚¢ãƒ€ãƒ—ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè·µ

### ğŸ“Š ç¾çŠ¶åˆ†æ

#### v1 ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆï¼ˆç¾åœ¨ï¼‰
```
weaver-core/src/
  â”œâ”€â”€ lib.rs
  â”œâ”€â”€ domain/          # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆids, task, job, outcome, decision, attempt, specï¼‰
  â”œâ”€â”€ queue/           # Queue trait + in-memoryå®Ÿè£…ï¼ˆçŠ¶æ…‹ç®¡ç†ã‚‚å«ã‚€ï¼‰
  â”œâ”€â”€ runtime/         # handler registry
  â”œâ”€â”€ worker/          # workerå®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
  â”œâ”€â”€ observability/   # status views
  â””â”€â”€ error/           # ã‚¨ãƒ©ãƒ¼å‹
```

#### v2 ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆï¼ˆç›®æ¨™ï¼‰
```
weaver-core/src/
  â”œâ”€â”€ lib.rs
  â”œâ”€â”€ domain/          # ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆids, task_type, envelope, budget, outcome, decision, state, errors, eventsï¼‰
  â”œâ”€â”€ ports/           # æŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆTaskStore, DeliveryQueue, ArtifactStore, Decider, ãªã©ï¼‰
  â”œâ”€â”€ app/             # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆbuilder, runtime, worker_loop, publisher_loop, ãªã©ï¼‰
  â”œâ”€â”€ typed/           # å‹ä»˜ãTask APIï¼ˆTask trait, Handler trait, TypedRegistry, PayloadCodecï¼‰
  â””â”€â”€ impls/           # å®Ÿè£…ï¼ˆInMemoryDeliveryQueue ãªã©é–‹ç™ºç”¨ï¼‰
```

### ğŸ” ä¸»ãªå¤‰æ›´ç‚¹

1. **`queue/` â†’ `ports/` + `app/` + `impls/`**
   - v1 ã® `queue/` ã¯è²¬å‹™ãŒæ··åœ¨ï¼ˆé…é€ + çŠ¶æ…‹ç®¡ç†ï¼‰
   - v2 ã§ã¯ `ports/delivery_queue.rs` ã«æŠ½è±¡åŒ–ã€`impls/inmem_delivery.rs` ã«å®Ÿè£…ã‚’åˆ†é›¢

2. **`runtime/` â†’ `app/runtime.rs`**
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã«çµ±åˆ

3. **`worker/` â†’ `app/worker_loop.rs`**
   - ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ«ãƒ¼ãƒ—ã¨ã—ã¦å†æ§‹æˆ

4. **æ–°è¦è¿½åŠ :**
   - `ports/` - æŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆtraitå®šç¾©ï¼‰
   - `typed/` - å‹ä»˜ãTask API
   - `app/` - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯

### ğŸ“ å®Ÿè£…ã™ã¹ãå†…å®¹

**å¤‰æ›´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:**
- `crates/weaver-core/src/lib.rs` - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®£è¨€ã®æ›´æ–°
- æ–°è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: `ports/`, `app/`, `typed/`, `impls/`
- å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® `mod.rs` ãƒ•ã‚¡ã‚¤ãƒ«

**æ®µéšçš„ç§»è¡Œæˆ¦ç•¥:**
1. **Phase 1**: æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆï¼ˆç©ºã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
2. **Phase 2**: æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°ã—ã„å ´æ‰€ã«ç§»å‹•ãƒ»ãƒªãƒãƒ¼ãƒ 
3. **Phase 3**: `lib.rs` ã® public API ã‚’èª¿æ•´
4. **Phase 4**: `cargo check` ã§ãƒ“ãƒ«ãƒ‰ç¢ºèª

### âœ… æ©Ÿèƒ½è¦ä»¶

- [ ] `domain/` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ•´ç†
  - [ ] `domain/ids.rs` - ULID newtypesï¼ˆæ¬¡ã®PRã§å®Ÿè£…ã€ä»Šã¯ placeholderï¼‰
  - [ ] `domain/task_type.rs` - task_type å‘½åè¦ç´„ã‚µãƒãƒ¼ãƒˆï¼ˆplaceholderï¼‰
  - [ ] `domain/envelope.rs` - TaskEnvelope å®šç¾©ï¼ˆplaceholderï¼‰
  - [ ] `domain/outcome.rs` - æ—¢å­˜ã‹ã‚‰ç§»å‹•
  - [ ] `domain/decision.rs` - æ—¢å­˜ã‹ã‚‰ç§»å‹•
  - [ ] `domain/state.rs` - TaskState/JobStateï¼ˆplaceholderï¼‰
  - [ ] `domain/errors.rs` - ã‚¨ãƒ©ãƒ¼å‹ï¼ˆplaceholderï¼‰
  - [ ] `domain/events.rs` - DomainEventï¼ˆplaceholderï¼‰
  - [ ] `domain/budget.rs` - Budgeté–¢é€£ï¼ˆplaceholderï¼‰

- [ ] `ports/` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
  - [ ] `ports/task_store.rs` - TaskStore traitï¼ˆplaceholderï¼‰
  - [ ] `ports/delivery_queue.rs` - DeliveryQueue traitï¼ˆplaceholderï¼‰
  - [ ] `ports/artifact_store.rs` - ArtifactStore traitï¼ˆplaceholderï¼‰
  - [ ] `ports/decider.rs` - Decider traitï¼ˆplaceholderï¼‰
  - [ ] `ports/dispatch.rs` - DispatchStrategy traitï¼ˆplaceholderï¼‰
  - [ ] `ports/repair_hint.rs` - RepairHintGenerator traitï¼ˆplaceholderï¼‰
  - [ ] `ports/clock.rs` - Clock traitï¼ˆplaceholderï¼‰
  - [ ] `ports/id_generator.rs` - IdGenerator traitï¼ˆplaceholderï¼‰
  - [ ] `ports/event_sink.rs` - EventSink traitï¼ˆplaceholderï¼‰

- [ ] `app/` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
  - [ ] `app/builder.rs` - AppBuilderï¼ˆplaceholderï¼‰
  - [ ] `app/runtime.rs` - Runtimeï¼ˆæ—¢å­˜ã‹ã‚‰ç§»å‹•ï¼‰
  - [ ] `app/worker_loop.rs` - WorkerLoopï¼ˆæ—¢å­˜ worker ã‹ã‚‰ç§»å‹•ï¼‰
  - [ ] `app/publisher_loop.rs` - OutboxPublisherLoopï¼ˆplaceholderï¼‰
  - [ ] `app/reaper_loop.rs` - LeaseReaperLoopï¼ˆplaceholderï¼‰
  - [ ] `app/gc_loop.rs` - GC loopï¼ˆplaceholderï¼‰
  - [ ] `app/status.rs` - Status queryï¼ˆæ—¢å­˜ observability ã‹ã‚‰ç§»å‹•ï¼‰

- [ ] `typed/` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
  - [ ] `typed/task.rs` - Task traitï¼ˆplaceholderï¼‰
  - [ ] `typed/handler.rs` - Handler traitï¼ˆplaceholderï¼‰
  - [ ] `typed/registry.rs` - TypedRegistryï¼ˆplaceholderï¼‰
  - [ ] `typed/codec.rs` - PayloadCodecï¼ˆplaceholderï¼‰

- [ ] `impls/` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ
  - [ ] `impls/inmem_delivery.rs` - InMemoryDeliveryQueueï¼ˆæ—¢å­˜ queue/memory ã‹ã‚‰ç§»å‹•ï¼‰

- [ ] `lib.rs` ã®æ›´æ–°
  - [ ] æ–°ã—ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã‚’åæ˜ 
  - [ ] public API ã®èª¿æ•´ï¼ˆbreaking change ã¯å¾Œã®PRã§å¯¾å¿œï¼‰

### ğŸš¨ æŠ€è¡“çš„åˆ¶ç´„ï¼ˆéå¸¸ã«é‡è¦ï¼‰

1. **æ®µéšçš„ç§»è¡Œ**
   - v1 ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨ã«å‰Šé™¤ã›ãšã€ä¸€æ™‚çš„ã«å…±å­˜ã•ã›ã‚‹
   - `#[deprecated]` ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã§å¤ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒãƒ¼ã‚¯
   - ä¾‹: `pub use queue::QueueTrait as OldQueue;` ãªã©

2. **ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼æœ€å°åŒ–**
   - å„ã‚¹ãƒ†ãƒƒãƒ—ã§ `cargo check` ã‚’å®Ÿè¡Œ
   - ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰1ã¤ãšã¤ä¿®æ­£

3. **Placeholder ã®ä½œæˆ**
   - ã¾ã å®Ÿè£…ã—ãªã„ trait/struct ã¯ç©ºå®šç¾©ã§ placeholder ã‚’ä½œæˆ
   - ä¾‹:
     ```rust
     // ports/task_store.rs
     /// Placeholder for TaskStore trait (PR-7ã§å®Ÿè£…äºˆå®š)
     pub trait TaskStore {
         // TODO(PR-7): å®Ÿè£…ã™ã‚‹
     }
     ```

4. **ãƒ†ã‚¹ãƒˆã®äº’æ›æ€§**
   - æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒå‹•ãç¶šã‘ã‚‹ã“ã¨ã‚’ç¢ºèª
   - ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®PRã§æ›´æ–°ã—ã¦ã‚‚OK

### ğŸ’¡ å®Ÿè£…ã®ãƒ’ãƒ³ãƒˆï¼ˆè³ªå•ãŒã‚ã‚Œã°èã„ã¦ãã ã•ã„ï¼‰

<details>
<summary>ãƒ’ãƒ³ãƒˆ1: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®£è¨€ã®åŸºæœ¬</summary>

```rust
// lib.rs
pub mod domain;
pub mod ports;
pub mod app;
pub mod typed;
pub mod impls;

// domain/mod.rs
pub mod ids;
pub mod task_type;
pub mod envelope;
// ... ãªã©

// ç‰¹å®šã®å‹ã‚’å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å ´åˆ
pub use self::ids::{JobId, TaskId};
```
</details>

<details>
<summary>ãƒ’ãƒ³ãƒˆ2: æ®µéšçš„ç§»è¡Œã®ä¾‹</summary>

```rust
// lib.rsï¼ˆç§»è¡ŒæœŸé–“ä¸­ï¼‰
pub mod domain;
pub mod ports;
pub mod app;
pub mod typed;
pub mod impls;

// v1äº’æ›ï¼ˆdeprecatedï¼‰
#[deprecated(note = "Use `app::runtime` instead")]
pub mod runtime;

#[deprecated(note = "Use `app::worker_loop` instead")]
pub mod worker;

// æ—¢å­˜ã‚³ãƒ¼ãƒ‰ãŒå‹•ãç¶šã‘ã‚‹ã‚ˆã†ã«å†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
#[deprecated]
pub use app::runtime as new_runtime;
```
</details>

<details>
<summary>ãƒ’ãƒ³ãƒˆ3: Placeholder trait ã®ä½œæˆ</summary>

```rust
// ports/task_store.rs
//! TaskStore port - PostgreSQL adapter ãŒå®Ÿè£…ã™ã‚‹ trait
//!
//! PR-7 ã§è©³ç´°å®Ÿè£…äºˆå®š

use crate::domain::ids::{JobId, TaskId};

/// TaskStore ã¯çŠ¶æ…‹ãƒ»å±¥æ­´ãƒ»ä¾å­˜ãƒ»outbox ã®æ­£æœ¬ï¼ˆsource of truthï¼‰
///
/// # å®Ÿè£…äºˆå®š
/// - `weaver-pg` ã‚¯ãƒ¬ãƒ¼ãƒˆã§ PostgreSQL å®Ÿè£…
/// - ãƒ†ã‚¹ãƒˆç”¨ã« InMemory å®Ÿè£…ã‚‚æ¤œè¨
pub trait TaskStore {
    // TODO(PR-7): ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©
    // - create_job
    // - create_task
    // - claim
    // - complete
    // - etc.
}
```
</details>

### ğŸ” å®Ÿè£…å¾Œã®ç¢ºèªäº‹é …

- [ ] `cargo check` ãŒæˆåŠŸã™ã‚‹
- [ ] æ–°ã—ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹
- [ ] æ—¢å­˜ã® v1 ã‚³ãƒ¼ãƒ‰ã¸ã®å‚ç…§ãŒ deprecated ã§è­¦å‘Šã•ã‚Œã‚‹
- [ ] `cargo clippy` ã§é‡å¤§ãªè­¦å‘ŠãŒãªã„
- [ ] ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆãŒè¦ä»¶ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆ3.2ç¯€ï¼‰ã¨ä¸€è‡´ã—ã¦ã„ã‚‹

---

## ğŸ“ å®Ÿè£…ãƒ¡ãƒ¢

### é–‹å§‹æ™‚åˆ»
-

### å®Ÿè£…ä¸­ã®æ°—ã¥ã
-

### çµ‚äº†æ™‚åˆ»
-

### å­¦ã‚“ã ã“ã¨
-

---

## ğŸ”— å‚è€ƒè³‡æ–™

- **v2 è¦ä»¶ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `dev/docs/requirements/2026_01_03_weaver_requirements.md` 3.2ç¯€
- **ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ**: `dev/learning/tasks.md` PR-1
- **CLAUDE.md**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

PR-1 å®Œäº†å¾Œ:
- PR-2: ULID Newtypes + IdGenerator/Clock â³ é–‹å§‹
- PR-3: Typed Task API

---

## â³ PR-2: ULID Newtypes + IdGenerator/Clockï¼ˆå­¦ç¿’ã‚¿ã‚¹ã‚¯ï¼‰

### ğŸ“‹ ã‚¿ã‚¹ã‚¯ã®æ¦‚è¦

åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ãˆã‚‹ ID ç”Ÿæˆã¨æ™‚åˆ»æŠ½è±¡åŒ–ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
v1 ã® `u64` ãƒ™ãƒ¼ã‚¹ã® ID ã‚’ ULID ãƒ™ãƒ¼ã‚¹ã«ç§»è¡Œã—ã€ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã®ãŸã‚ã« trait ã§æŠ½è±¡åŒ–ã—ã¾ã™ã€‚

### ğŸ¯ å­¦ç¿’ç›®æ¨™

ã“ã®ã‚¿ã‚¹ã‚¯ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã® Rust ã®æ¦‚å¿µã‚’å®Ÿè·µçš„ã«å­¦ã³ã¾ã™ï¼š

1. **ULID ã®ç‰¹æ€§** - æ™‚åˆ»ã§ã‚½ãƒ¼ãƒˆå¯èƒ½ã€åˆ†æ•£ç’°å¢ƒã§ç”Ÿæˆå¯èƒ½ãª ID
2. **Newtype ãƒ‘ã‚¿ãƒ¼ãƒ³** - å‹å®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ Rust ã®å¼·åŠ›ãªãƒ‘ã‚¿ãƒ¼ãƒ³
3. **Trait ã«ã‚ˆã‚‹ä¾å­˜æ€§æ³¨å…¥** - ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã‚’é«˜ã‚ã‚‹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³
4. **From/Into ãƒˆãƒ¬ã‚¤ãƒˆ** - å‹å¤‰æ›ã®æ…£ç”¨çš„ãªå®Ÿè£…

### ğŸ“Š v1 vs v2 ã®é•ã„

#### v1ï¼ˆç¾åœ¨ï¼‰
```rust
// u64 ãƒ™ãƒ¼ã‚¹ã® newtype
pub struct JobId(u64);
pub struct TaskId(u64);
pub struct AttemptId(u64);

// ä½¿ç”¨ä¾‹
let job_id = JobId::new(1);  // å˜èª¿å¢—åŠ ã® u64
```

#### v2ï¼ˆç›®æ¨™ï¼‰
```rust
// ULID ãƒ™ãƒ¼ã‚¹ã® newtype
pub struct JobId(ulid::Ulid);
pub struct TaskId(ulid::Ulid);
pub struct AttemptId(ulid::Ulid);

// IdGenerator trait ã§ç”Ÿæˆ
let job_id = id_gen.generate_job_id();  // æ™‚åˆ»ã‚½ãƒ¼ãƒˆå¯èƒ½ã€åˆ†æ•£ç”Ÿæˆå¯èƒ½
```

### ğŸ“ å®Ÿè£…ã™ã¹ãå†…å®¹

**å¤‰æ›´ãƒ»è¿½åŠ ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:**
1. `crates/weaver-core/Cargo.toml` - ulid ã‚¯ãƒ¬ãƒ¼ãƒˆè¿½åŠ 
2. `crates/weaver-core/src/domain/ids.rs` - ULID ãƒ™ãƒ¼ã‚¹ã«æ›¸ãæ›ãˆ
3. `crates/weaver-core/src/ports/id_generator.rs` - IdGenerator trait + UlidGenerator
4. `crates/weaver-core/src/ports/clock.rs` - Clock trait + SystemClock + FixedClock

### âœ… æ©Ÿèƒ½è¦ä»¶

#### 1. ulid ã‚¯ãƒ¬ãƒ¼ãƒˆã®å°å…¥
- [ ] `Cargo.toml` ã« `ulid = { version = "1.1", features = ["serde"] }` ã‚’è¿½åŠ 
- [ ] `cargo check` ã§ä¾å­˜é–¢ä¿‚ãŒè§£æ±ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

#### 2. ULID newtypesï¼ˆdomain/ids.rsï¼‰
- [ ] `JobId(ulid::Ulid)` ã«å¤‰æ›´
- [ ] `TaskId(ulid::Ulid)` ã«å¤‰æ›´
- [ ] `AttemptId(ulid::Ulid)` ã«å¤‰æ›´
- [ ] å„å‹ã«ä»¥ä¸‹ã‚’å®Ÿè£…:
  - [ ] `Serialize/Deserialize` (derive)
  - [ ] `Debug, Clone, Copy, PartialEq, Eq, Hash, PartialOrd, Ord` (derive)
  - [ ] `Display` ãƒˆãƒ¬ã‚¤ãƒˆï¼ˆhuman-friendly è¡¨ç¤ºï¼‰
  - [ ] `From<ulid::Ulid>` ãƒˆãƒ¬ã‚¤ãƒˆï¼ˆå¤‰æ›ï¼‰
  - [ ] `as_ulid()` ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå†…éƒ¨å€¤ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

#### 3. IdGenerator traitï¼ˆports/id_generator.rsï¼‰
- [ ] `IdGenerator` trait ã®å®šç¾©:
  ```rust
  pub trait IdGenerator {
      fn generate_job_id(&self) -> JobId;
      fn generate_task_id(&self) -> TaskId;
      fn generate_attempt_id(&self) -> AttemptId;
  }
  ```
- [ ] `UlidGenerator` æ§‹é€ ä½“ã®å®Ÿè£…ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®Ÿè£…ï¼‰
- [ ] `Clock` ã‚’ä½¿ã£ã¦ç¾åœ¨æ™‚åˆ»ãƒ™ãƒ¼ã‚¹ã® ULID ã‚’ç”Ÿæˆ

#### 4. Clock traitï¼ˆports/clock.rsï¼‰
- [ ] `Clock` trait ã®å®šç¾©:
  ```rust
  pub trait Clock {
      fn now(&self) -> DateTime<Utc>;
  }
  ```
- [ ] `SystemClock` æ§‹é€ ä½“ã®å®Ÿè£…ï¼ˆæœ¬ç•ªç”¨ã€`Utc::now()` ã‚’å‘¼ã¶ï¼‰
- [ ] `FixedClock` æ§‹é€ ä½“ã®å®Ÿè£…ï¼ˆãƒ†ã‚¹ãƒˆç”¨ã€å›ºå®šæ™‚åˆ»ã‚’è¿”ã™ï¼‰

#### 5. ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] `domain/ids.rs` ã®ãƒ†ã‚¹ãƒˆ:
  - [ ] ULID ã®å˜èª¿å¢—åŠ æ€§ãƒ†ã‚¹ãƒˆ
  - [ ] Serialize/Deserialize ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—ãƒ†ã‚¹ãƒˆ
  - [ ] Display ã®è¡¨ç¤ºå½¢å¼ãƒ†ã‚¹ãƒˆ
- [ ] `ports/id_generator.rs` ã®ãƒ†ã‚¹ãƒˆ:
  - [ ] UlidGenerator ãŒä¸€æ„ãª ID ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚’ç¢ºèª
  - [ ] FixedClock ã‚’ä½¿ã£ã¦æ±ºå®šçš„ãªãƒ†ã‚¹ãƒˆã‚’æ›¸ã
- [ ] `ports/clock.rs` ã®ãƒ†ã‚¹ãƒˆ:
  - [ ] SystemClock ãŒç¾åœ¨æ™‚åˆ»ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
  - [ ] FixedClock ãŒå›ºå®šæ™‚åˆ»ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª

### ğŸš¨ æŠ€è¡“çš„åˆ¶ç´„ï¼ˆéå¸¸ã«é‡è¦ï¼‰

1. **ULID ã®ç‰¹æ€§ã‚’ç†è§£ã™ã‚‹**
   - ULID ã¯ 128-bitï¼ˆ16 bytesï¼‰
   - æœ€åˆã® 48-bit ãŒ timestampï¼ˆãƒŸãƒªç§’å˜ä½ï¼‰
   - æ®‹ã‚Šã® 80-bit ãŒãƒ©ãƒ³ãƒ€ãƒ 
   - æ™‚åˆ»ã§ã‚½ãƒ¼ãƒˆå¯èƒ½ï¼ˆtimestamp ãŒå…ˆé ­ã«ã‚ã‚‹ãŸã‚ï¼‰

2. **v1 ã¨ã®äº’æ›æ€§**
   - v1 ã® `u64` ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ¼ãƒ‰ã¯æ®‹ã™ï¼ˆdeprecated ã«ã—ãªã„ï¼‰
   - v2 ã® ULID ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸¦è¡Œã—ã¦å®Ÿè£…
   - ç§»è¡Œã¯æ®µéšçš„ã«è¡Œã†

3. **Trait bound ã®è¨­è¨ˆ**
   - `IdGenerator` ã¯ `Send + Sync` ã«ã™ã‚‹ï¼ˆè¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ä½¿ãˆã‚‹ï¼‰
   - `Clock` ã‚‚ `Send + Sync` ã«ã™ã‚‹

### ğŸ’¡ å®Ÿè£…ã®ãƒ’ãƒ³ãƒˆï¼ˆè³ªå•ãŒã‚ã‚Œã°èã„ã¦ãã ã•ã„ï¼‰

<details>
<summary>ãƒ’ãƒ³ãƒˆ1: ULID ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹</summary>

```rust
use ulid::Ulid;

// ULID ã®ç”Ÿæˆ
let id = Ulid::new();

// æ–‡å­—åˆ—ã¸ã®å¤‰æ›
let s = id.to_string();  // "01ARZ3NDEKTSV4RRFFQ69G5FAV" ã®ã‚ˆã†ãªå½¢å¼

// æ–‡å­—åˆ—ã‹ã‚‰ã®ãƒ‘ãƒ¼ã‚¹
let parsed = Ulid::from_string(&s).unwrap();

// ãƒã‚¤ãƒˆåˆ—ã¸ã®å¤‰æ›
let bytes = id.to_bytes();
```
</details>

<details>
<summary>ãƒ’ãƒ³ãƒˆ2: Newtype ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…</summary>

```rust
use ulid::Ulid;
use serde::{Deserialize, Serialize};

#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
#[repr(transparent)]
pub struct JobId(Ulid);

impl JobId {
    pub fn as_ulid(&self) -> Ulid {
        self.0
    }
}

impl From<Ulid> for JobId {
    fn from(ulid: Ulid) -> Self {
        Self(ulid)
    }
}

impl std::fmt::Display for JobId {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        write!(f, "job-{}", self.0)
    }
}
```
</details>

<details>
<summary>ãƒ’ãƒ³ãƒˆ3: IdGenerator ã®å®Ÿè£…</summary>

```rust
use crate::ports::Clock;
use crate::domain::ids::{JobId, TaskId, AttemptId};
use ulid::Ulid;

pub struct UlidGenerator<C> {
    clock: C,
}

impl<C: Clock> UlidGenerator<C> {
    pub fn new(clock: C) -> Self {
        Self { clock }
    }
}

impl<C: Clock> IdGenerator for UlidGenerator<C> {
    fn generate_job_id(&self) -> JobId {
        let timestamp_ms = self.clock.now().timestamp_millis() as u64;
        let ulid = Ulid::from_parts(timestamp_ms, rand::random());
        JobId::from(ulid)
    }

    // åŒæ§˜ã« generate_task_id, generate_attempt_id ã‚’å®Ÿè£…
}
```
</details>

<details>
<summary>ãƒ’ãƒ³ãƒˆ4: Clock ã®å®Ÿè£…</summary>

```rust
use chrono::{DateTime, Utc};

pub trait Clock: Send + Sync {
    fn now(&self) -> DateTime<Utc>;
}

pub struct SystemClock;

impl Clock for SystemClock {
    fn now(&self) -> DateTime<Utc> {
        Utc::now()
    }
}

pub struct FixedClock {
    time: DateTime<Utc>,
}

impl FixedClock {
    pub fn new(time: DateTime<Utc>) -> Self {
        Self { time }
    }
}

impl Clock for FixedClock {
    fn now(&self) -> DateTime<Utc> {
        self.time
    }
}
```
</details>

### ğŸ” å®Ÿè£…å¾Œã®ç¢ºèªäº‹é …

- [ ] `cargo check` ãŒæˆåŠŸã™ã‚‹
- [ ] `cargo test` ãŒæˆåŠŸã™ã‚‹
- [ ] `cargo clippy` ã§é‡å¤§ãªè­¦å‘ŠãŒãªã„
- [ ] ULID ã®å˜èª¿å¢—åŠ æ€§ãŒç¢ºèªã§ãã‚‹
- [ ] FixedClock ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆãŒæ±ºå®šçš„ã«å‹•ä½œã™ã‚‹

---

## ğŸ“ å®Ÿè£…ãƒ¡ãƒ¢ï¼ˆPR-2ï¼‰

### é–‹å§‹æ™‚åˆ»
2026-01-04 (ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹)

### å®Ÿè£…ä¸­ã®æ°—ã¥ã

#### Phantom Type ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¡ç”¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ææ¡ˆã§ã€å€‹åˆ¥ newtype ã§ã¯ãªãã‚¸ã‚§ãƒãƒªãƒƒã‚¯ `Id<T>` ã‚’æ¡ç”¨
- `PhantomData<T>` ã§ã‚¼ãƒ­ã‚³ã‚¹ãƒˆæŠ½è±¡åŒ–ã‚’å®Ÿç¾
- ã‚³ãƒ¼ãƒ‰é‡: 180è¡Œï¼ˆå€‹åˆ¥å®Ÿè£…ï¼‰ â†’ 120è¡Œï¼ˆã‚¸ã‚§ãƒãƒªãƒƒã‚¯å®Ÿè£…ï¼‰

#### Rust ã®äºˆç´„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ `gen`
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ `gen` ã‚’å¤‰æ•°åã¨ã—ã¦ä½¿ç”¨ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼
- `gen` ã¯ Rust ã®äºˆç´„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆgenerator é–¢é€£ï¼‰
- `id_gen` ã«å¤‰æ›´ã—ã¦è§£æ±º

#### ãƒãƒ¼ã‚«ãƒ¼å‹ã«å¿…è¦ãª trait
- æœ€åˆã¯ `Debug, Clone, Copy, PartialEq, Eq` ã®ã¿
- HashMap ã®ã‚­ãƒ¼ã¨ã—ã¦ä½¿ã†ãŸã‚ `Hash` ãŒå¿…è¦
- ã‚½ãƒ¼ãƒˆå¯èƒ½ã«ã™ã‚‹ãŸã‚ `PartialOrd, Ord` ã‚‚è¿½åŠ 
- æœ€çµ‚: `#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, PartialOrd, Ord)]`

#### v1 äº’æ› API ã®å‰Šé™¤
- æœ€åˆã¯ v1 äº’æ› API (`.new()`, `.get()`, `.as_u64()`) ã‚’è¿½åŠ 
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ¤æ–­ã§å‰Šé™¤ï¼ˆv2 ã¸ã®ç§»è¡Œã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ï¼‰
- v1 ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãªã®ã§ã€ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã§ã‚‚å•é¡Œãªã—

### çµ‚äº†æ™‚åˆ»
2026-01-04 (ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†)

### å­¦ã‚“ã ã“ã¨

#### Phantom Type ãƒ‘ã‚¿ãƒ¼ãƒ³
- `PhantomData<T>` ã§å‹å®‰å…¨æ€§ã‚’ç¶­æŒã—ãªãŒã‚‰ã‚³ãƒ¼ãƒ‰é‡è¤‡ã‚’å‰Šæ¸›
- å®Ÿè¡Œæ™‚ã®ãƒ¡ãƒ¢ãƒªã‚³ã‚¹ãƒˆã¯ã‚¼ãƒ­ï¼ˆ16 bytes ã®ã¾ã¾ï¼‰
- ãƒãƒ¼ã‚«ãƒ¼å‹ã¯ empty enum ã§å®šç¾©ã—ã€trait ã§æŒ¯ã‚‹èˆã„ã‚’æä¾›

#### Trait ã«ã‚ˆã‚‹ä¾å­˜æ€§æ³¨å…¥
- `Clock` trait ã§æ™‚åˆ»ã‚’æŠ½è±¡åŒ–
- ãƒ†ã‚¹ãƒˆã§ `FixedClock` ã‚’æ³¨å…¥ã—ã¦æ±ºå®šçš„ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿç¾
- `IdGenerator` ãŒ `Clock` ã«ä¾å­˜ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ãŒå‘ä¸Š

#### ULID ã®ç‰¹æ€§
- 128-bitï¼ˆ16 bytesï¼‰
- æœ€åˆã® 48-bit ãŒ timestampï¼ˆãƒŸãƒªç§’å˜ä½ï¼‰
- æ®‹ã‚Šã® 80-bit ãŒãƒ©ãƒ³ãƒ€ãƒ 
- æ™‚åˆ»ã§ã‚½ãƒ¼ãƒˆå¯èƒ½ï¼ˆtimestamp ãŒå…ˆé ­ï¼‰
- PostgreSQL ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŠ¹ç‡ãŒ UUID ã‚ˆã‚Šå„ªã‚Œã‚‹

#### Learning Mode ã®æ”¹å–„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯: ã€Œæ¬¡ã‹ã‚‰ã¯ç§ã«å®Ÿè£…ã•ã›ã¦ãã ã•ã„ã€
- CLAUDE.md ã‚’æ›´æ–°: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ TODO(human) + "Learn by Doing" â†’ å¾…æ©Ÿ
- ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ï¼ˆ1/3ï¼‰ã¯ OKã€æ®‹ã‚Šã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿè£…
